<?xml version="1.0" encoding="UTF-8"?>

<databaseChangeLog xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
	xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
	xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog
         http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-3.1.xsd">

	<changeSet id="qc-metrics" author="tom">

		<createTable tableName="qc_entry">
			<column name="id" autoIncrement="true" type="bigint(20)">
				<constraints primaryKey="true" nullable="false" />
			</column>
			<column name="created_date" type="datetime">
				<constraints nullable="false" />
			</column>
			<column name="DTYPE" type="varchar(31)">
				<constraints nullable="false" />
			</column>
			<column name="sample_id" type="bigint(20)">
				<constraints referencedTableName="sample"
					referencedColumnNames="id" foreignKeyName="FK_SAMPLE_QC_ENTRY" />
			</column>
		</createTable>

		<sql>
			insert into qc_entry (DTYPE, sample_id, created_date) select
			distinct
			'FileProcessorErrorQCEntry', a.sample_id, now() from
			sample_sequencingobject a INNER JOIN sequence_file_pair_files p ON
			p.pair_id=a.sequencingobject_id INNER JOIN sequence_file s ON
			s.id=p.files_id where s.file_path like "%.fastq.gz"
		</sql>

		<sql>
			insert into qc_entry (DTYPE, sample_id, created_date) select distinct
			'FileProcessorErrorQCEntry', a.sample_id, now() from
			sample_sequencingobject a INNER JOIN sequence_file_single_end p ON
			p.id=a.sequencingobject_id INNER JOIN sequence_file s ON
			s.id=p.file_id where s.file_path like "%.fastq.gz"
		</sql>
	</changeSet>
</databaseChangeLog>
