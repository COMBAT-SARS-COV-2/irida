<?xml version="1.0" encoding="UTF-8"?>

<databaseChangeLog xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
	xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
	xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog
         http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-3.1.xsd">

	<changeSet id="sequencing-objects" author="tom">

		<!-- Create the sequencing object tables -->
		<createTable tableName="sequencing_object">
			<column name="id" type="bigint(20)" autoIncrement="true">
				<constraints primaryKey="true" nullable="false" />
			</column>
			<column name="created_date" type="datetime">
				<constraints nullable="false" />
			</column>
		</createTable>

		<createTable tableName="sequencing_object_AUD">
			<column name="id" type="bigint(20)">
				<constraints primaryKey="true" nullable="false" />
			</column>
			<column name="created_date" type="datetime" />
			<column name="REV" type="int(11)">
				<constraints primaryKey="true" referencedColumnNames="id"
					referencedTableName="Revisions" foreignKeyName="FK_SEQUENCING_OBJECT_AUD" />
			</column>
			<column name="REVTYPE" type="tinyint(4)" />
		</createTable>

		<!-- Map SequenceFilePair ids and dates up to SequencingObject -->
		<sql>
			INSERT INTO sequencing_object (id, created_date) SELECT id,
			created_date FROM sequence_file_pair
		</sql>

		<!-- Ditch the date column in SequenceFilePair -->
		<dropColumn columnName="created_date" tableName="sequence_file_pair" />

		<!-- temporarily disable some FKs on SequenceFilePair so we can remove 
			the auto increment -->
		<dropForeignKeyConstraint baseTableName="analysis_submission_sequence_file_pair"
			constraintName="FK_ANALYSIS_SUBMISSION_SEQUENCE_FILE_PAIR_FILE_ID" />

		<dropForeignKeyConstraint baseTableName="sequence_file_pair_files"
			constraintName="FK_SEQUENCE_FILE_PAIR_FILES_PAIR" />

		<!-- Redefine id for SequenceFilePair so that it doesn't auto increment -->
		<modifyDataType columnName="id" newDataType="bigint(20)"
			tableName="sequence_file_pair" />

		<dropDefaultValue columnDataType="bigint(20)"
			columnName="id" tableName="sequence_file_pair" />

		<!-- Add a FK to SequencingObject from SequenceFilePair -->
		<addForeignKeyConstraint baseColumnNames="id"
			baseTableName="sequence_file_pair" constraintName="FK_SEQUENCE_FILE_PAIR_OBJECT"
			referencedColumnNames="id" referencedTableName="sequencing_object" />

		<!-- Re-enable the disabled FKs -->
		<addForeignKeyConstraint baseColumnNames="sequence_file_pair_id"
			baseTableName="analysis_submission_sequence_file_pair"
			constraintName="FK_ANALYSIS_SUBMISSION_SEQUENCE_FILE_PAIR_FILE_ID"
			referencedColumnNames="id" referencedTableName="sequence_file_pair" />

		<addForeignKeyConstraint baseColumnNames="pair_id"
			baseTableName="sequence_file_pair_files" constraintName="FK_SEQUENCE_FILE_PAIR_FILES_PAIR"
			referencedColumnNames="id" referencedTableName="sequence_file_pair" />

		<!-- Create a table for SingleEndSequenceFile -->
		<createTable tableName="sequence_file_single_end">
			<column name="id" type="bigint(20)">
				<constraints primaryKey="true" nullable="false"
					referencedTableName="sequencing_object" referencedColumnNames="id"
					foreignKeyName="FK_SEQUENCE_FILE_SINGLE_OBJECT" />
			</column>
			<column name="file_id" type="bigint(20)">
				<constraints nullable="false" referencedTableName="sequence_file"
					referencedColumnNames="id" foreignKeyName="FK_SEQUENCE_FILE_SINGLE_FILE" />
			</column>
		</createTable>

		<createTable tableName="sequence_file_single_end_AUD">
			<column name="id" type="bigint(20)">
				<constraints primaryKey="true" nullable="false" />
			</column>
			<column name="file_id" type="bigint(20)" />
			<column name="REV" type="int(11)">
				<constraints primaryKey="true" referencedColumnNames="id"
					referencedTableName="Revisions" foreignKeyName="FK_SEQUENCE_FILE_SINGLE_AUD" />
			</column>
			<column name="REVTYPE" type="tinyint(4)" />
		</createTable>

		<!-- Adding a temporary column to store a file id for a SingleEndSequenceFile -->
		<addColumn tableName="sequencing_object">
			<column name="tmp_file_id" type="bigint(20)" />
		</addColumn>

		<!-- Adding SequencingObjects for new SingleEndSequenceFiles. Also temporarily 
			storing the file id here -->
		<sql>
			INSERT INTO sequencing_object (created_date, tmp_file_id) SELECT
			f.created_date, f.id FROM
			sequence_file f WHERE f.id NOT IN (select
			files_id from
			sequence_file_pair_files)
		</sql>

		<!-- Inserting new SingleEndSequenceFiles into their table -->
		<sql>
			INSERT INTO sequence_file_single_end (id, file_id) SELECT id,
			tmp_file_id FROM sequencing_object WHERE tmp_file_id IS NOT NULL
		</sql>

		<!-- Ditching the temporary column -->
		<dropColumn columnName="tmp_file_id" tableName="sequencing_object" />

	</changeSet>
</databaseChangeLog>
