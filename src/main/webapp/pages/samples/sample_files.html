<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorator="samples/_base">
<head lang="en">
	<meta charset="UTF-8"/>
	<title th:text="#{samples.files.title(${sample.label})}">THIS IS SOMETHING WRONG</title>
	<script>window.dependencies = ['irida.sample.files'];</script>
	<style>
		.flexed {
			display: flex;
		}

		.file-upload-progress, .file-upload-error {
			padding-top: 0 !important;
		}

		.file-upload-progress {
			display: none!important;
		}

		.file-upload-progress.fadeIn{
			display: flex!important;
		}

		.file-upload-error .alert {
			margin: 0!important;
		}

		.modal-body .alert {
			margin: 7px 0!important;
			padding: 0 14px!important;
		}

		.modal-body .alert label {
			width: 100%;
			margin: 0 !important;
			padding: 0 !important;
			cursor: pointer;
			font-weight: normal;
		}

		.progress {
			margin-bottom: 0;
			flex-grow: 2;
			margin-right: 1em;
		}

		.seq-file {
			display: flex;
			justify-content: center;
		}

		.seq-file_name {
			flex-grow: 2;
			overflow: hidden;
			white-space: nowrap;
		}

		.seq-file_size {
			width: 100px;
		}

		.seq-file_remove {
			width: 30px;
		}

	</style>
</head>
<body>

<div class="panel panel-default" ng-controller="FileUploadController as fileUploadCtrl" layout:fragment="sidebar">
	<form name="uploadForm">
		<div class="panel-heading">
			<button class="btn btn-default btn-sm btn-block" name="files"
					ngf-change="fileUploadCtrl.uploadFiles($files, $event, $rejectedFiles)"
					ngf-accept="'.fastq,.fastq.gz'"
					ngf-select=""
					multiple="true">
				<th:block th:text="#{samples.files.upload.btn}"></th:block>
				&nbsp;
				<fa:icon type="upload"/>
			</button>
		</div>
		<div class="ng-cloak panel-body file-upload-progress flexed animated"
			 ng-class="{fadeIn: fileUploadCtrl.uploading, fadeOut: !fileUploadCtrl.uploading}">
			<progressbar class="progress-striped active" value="fileUploadCtrl.progress">{{ fileUploadCtrl.progress
				}}%
			</progressbar>
			<button class="btn btn-default btn-xs" ng-click="fileUploadCtrl.cancel()">
				<fa:icon type="remove"/>
			</button>
		</div>
	</form>
</div>

<main layout:fragment="main" ddl:bundle-includes="sample-files">
	<div class="row">
		<div class="col-md-12">
			<h1 id="page-title" th:text="#{samples.files.page-title(${sample.getLabel()})}"></h1>
			<div id="file-deleted-success" th:if="${fileDeletedMessage}" class="alert alert-success"
			     role="alert">
				<strong th:text="${fileDeletedMessage}"></strong>
			</div>
			<div th:if="${fileDeletedError}" class="alert alert-error" role="alert">
				<strong th:text="${fileDeletedError}"></strong>
			</div>
		</div>
	</div>
	<div class="row">
		<div class="col-md-12">
			<table class="table" th:with="dateFormat=#{locale.date.short}, url=@{${#httpServletRequest.requestURI}}"
			       ng-controller="FileController as fileCtrl">
				<th:block th:each="pair : ${paired_end}">
					<tr class="paired_end paired_end__forward" th:with="file=${pair.getForwardSequenceFile()}">
						<td th:replace="templates/_sequenceFile :: sequenceFileTableLayout (file=${file},icon='forward')"></td>
						<td>
							<div class="btn-group-sm pull-right" role="group">
								<button th:if="${canManageSample}"
								        class="btn btn-default remove-pair"
								        th:with="fId=${file.id + ', &#39;'' + file.getLabel() + ''&#39;'}"
								        data:ng-click="${'fileCtrl.deletePair(' + pair.id + ', &#39;'' + pair.getForwardSequenceFile().getLabel() +'&#39;',&#39;''+pair.getReverseSequenceFile().getLabel()+'&#39;')'}">
									<span class="fa fa-fw fa-trash"></span>
								</button>
                                <button class="btn btn-default"
								        data:ng-click="${'fileCtrl.download(' + file.getId() + ')'}">
									<span class="fa fa-fw fa-download"></span>
								</button>
							</div>
						</td>
					</tr>
					<tr class="paired_end paired_end__reverse" th:with="file=${pair.getReverseSequenceFile()}">
						<td th:replace="templates/_sequenceFile :: sequenceFileTableLayout (file=${file},icon='reverse')"></td>
						<td>
							<div class="btn-group btn-group-sm pull-right" role="group">
								<button class="btn btn-default"
								        data:ng-click="${'fileCtrl.download(' + file.getId() + ')'}">
									<span class="fa fa-fw fa-download"></span>
								</button>
							</div>
						</td>
					</tr>
				</th:block>
				<tr class="single_end" th:each="join : ${single_end}" th:with="file=${join.getObject()}">
					<td th:replace="templates/_sequenceFile :: sequenceFileTableLayout (file=${file},icon='single')"></td>
					<td>
						<div class="btn-group-sm pull-right" role="group">
                            <button th:if="${canManageSample}"
							        class="btn btn-default remove-file"
							        th:with="fId=${file.id + ', &#39;'' + file.getLabel() + ''&#39;'}"
							        data:ng-click="${'fileCtrl.deleteFile(' + fId + ')'}">
								<span class="fa fa-fw fa-trash"></span>
							</button>
							<button class="btn btn-default"
							        data:ng-click="${'fileCtrl.download(' + file.getId() + ')'}">
								<span class="fa fa-fw fa-download"></span>
							</button>

						</div>
					</td>
				</tr>
			</table>
		</div>
	</div>

</main>
<th:block layout:fragment="page-scripts" th:inline="javascript">
	<script type="text/ng-template" id="/upload-error.html">
		<div class="modal-header">
			<h2>
				<fa:icon type="warning" size="2x"/>
				&nbsp;&nbsp;
				<th:block th:text="#{project.samples.files.error.title}"></th:block>
			</h2>
		</div>
		<div class="modal-body">
			<h3>
				<ng-pluralize count="rejectModalCtrl.rejects.length"
							  th:attr="when='{\'1\' : \'' + #{project.samples.files.error.bad-files.single} + '\', \'other\': \'' + #{project.samples.files.error.bad-files.plural} + '\'}'">
				</ng-pluralize>
			</h3>
			<alert type="danger" ng-repeat="file in rejectModalCtrl.rejects">
				<strong>{{file.name}}</strong>

				<div class="pull-right">{{ file.size | humanReadableBytes }}</div>
			</alert>
			<div ng-if="rejectModalCtrl.good.length">
				<h3>
					<ng-pluralize count="rejectModalCtrl.good.length"
								  th:attr="when='{\'1\' : \'' + #{project.samples.files.error.good-files.single} + '\', \'other\': \'' + #{project.samples.files.error.good-files.plural} + '\'}'">
					</ng-pluralize>
				</h3>
				<alert type="success">
					<label ng-repeat="file in rejectModalCtrl.good"><input type="checkbox" ng-init="file.selected=true" ng-model="file.selected"/>&nbsp;&nbsp;
						<strong>{{file.name}}</strong>

						<div class="pull-right">{{ file.size | humanReadableBytes }}</div>
					</label>
				</alert>
			</div>
		</div>
		<div class="modal-footer" ng-if="rejectModalCtrl.good.length">
			<button class="btn btn-default" ng-click="rejectModalCtrl.cancel()"
					th:text="#{samples.files.upload.modal.cancel}">_NO, Cancel Upload
			</button>
			<button class="btn btn-primary" ng-click="rejectModalCtrl.finish()"
					th:text="#{samples.files.upload.modal.finish}">_Yes, Upload Selected files
			</button>
		</div>
		<div class="modal-footer" ng-if="rejectModalCtrl.good.length === 0">
			<button class="btn btn-default btn-primary" ng-click="rejectModalCtrl.cancel()"
					th:text="#{samples.files.upload.modal.try-again}">_Ok, try again
			</button>
		</div>
	</script>
	<script type="text/ng-template" id="/confirm.html">
		<form method="post" th:action="@{/samples/{sId}/files/delete(sId=${sampleId})}">
			<div class="modal-header">
			<h3 class="modal-title" th:text="#{samples.files.remove.confirmation}"></h3>
		</div>
		<div class="modal-body">
			<h4>{{ ::deleteCtrl.label }}</h4>
			<input type="hidden" name="fileId" value="{{ deleteCtrl.fileId }}"/>
		</div>
		<div class="modal-footer">
			<button type="button" class="btn btn-default" ng-click="deleteCtrl.cancel()" th:text="#{form.btn.cancel}">Cancel</button>
			<button id="remove-file-confirm" type="submit" class="btn btn-warning remove-file-confirm" th:text="#{form.btn.remove}">OK</button>
		</div>
		</form>
	</script>

    <script type="text/ng-template" id="/confirm_pair.html">
		<form method="post" th:action="@{/samples/{sId}/files/delete/pair(sId=${sampleId})}">
			<div class="modal-header">
			<h3 class="modal-title" th:text="#{samples.files.remove.confirmation}"></h3>
		</div>
		<div class="modal-body">
			<h4>{{ ::deleteCtrl.label }}</h4>
			<input type="hidden" name="pairId" value="{{ deleteCtrl.fileId }}"/>
		</div>
		<div class="modal-footer">
			<button type="button" class="btn btn-default" ng-click="deleteCtrl.cancel()" th:text="#{form.btn.cancel}">Cancel</button>
			<button id="remove-file-confirm" type="submit" class="btn btn-warning remove-file-confirm" th:text="#{form.btn.remove}">OK</button>
		</div>
		</form>
	</script>
	<script th:inline="javascript">
		var PAGE = {
			sample: {
				id: /*[[${sample.getId()}]]*/ '1'
			},
			i18n: {
				leaving: /*[[#{project.samples.files.upload.page-leave}]]*/ "Leaving the page will cause your file upload to be cancelled."
			}
		};
	</script>
</th:block>
</body>
</html>
