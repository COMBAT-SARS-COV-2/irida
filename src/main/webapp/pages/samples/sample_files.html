<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorator="samples/_base">
<head lang="en">
    <meta charset="UTF-8"/>
    <title th:text="#{samples.files.title(${sample.label})}">THIS IS SOMETHING WRONG</title>
    <link rel="stylesheet" th:href="@{/resources/bower_components/DataTables/media/css/jquery.dataTables.min.css}"
          href="/resources/bower_components/DataTables/media/css/jquery.dataTables.min.css"/>
</head>
<body>
<main layout:fragment="main">
    <div class="row">
        <div class="col-md-12">
            <h1 id="page-title" role="heading" th:text="#{samples.files.page-title(${sample.getLabel()})}">
                __TITLE__</h1>
        </div>
    </div>
    <div class="row">
        <div class="col-md-12">
            <table id="filesTable">
                <thead>
                <tr role="row">
                    <th th:text="#{samples.files.id}">ID</th>
                    <th th:text="#{samples.files.name}">Name</th>
                    <th th:text="#{samples.files.uploaded}">Uploaded</th>
                    <th th:text="#{samples.files.size}">Size</th>
                    <th></th>
                </tr>
                </thead>
                <tbody>
                <tr role="row" th:each="file : ${files}" th:with="dateFormat=#{locale.date.long}" th:id="${'file-row-' + file.id}">
                    <td class="file-id" th:text="${file.id}">ID</td>
                    <td><a class="file-name" th:href="@{/sequenceFiles/{id}(id=${file.id})}" href="#"
                           th:text="${file.label}"></a></td>
                    <td data:order="${file.realCreatedDate}"
                        th:title="${#dates.format(file.realCreatedDate, dateFormat)}" th:text="${file.createdDate}">Date
                    </td>
                    <td data:order="${file.realSize}" th:text="${file.size}"></td>
                    <td class="file-buttons">
                        <span th:if="${canManageSample}">
                            <button class="btn btn-danger btn-sm remove-file pull-right" 
                                th:text="#{form.btn.remove}"
                                th:attr="data-file-id=${file.id}">_Remove_</button>
                            </span>
                    </td>
                </tr>
                </tbody>
            </table>
        </div>
    </div>
</main>
<th:block layout:fragment="pageScripts" th:inline="javascript">
    <script th:src="@{/resources/bower_components/DataTables/media/js/jquery.dataTables.min.js}"
            src="/resources/bower_components/DataTables/media/js/jquery.dataTables.min.js"></script>
    <script th:src="@{/resources/bower_components/noty/js/noty/packaged/jquery.noty.packaged.min.js}"
        src="/resources/bower_components/noty/js/noty/packaged/jquery.noty.packaged.min.js"></script>            
    <script>
        /*<![CDATA[*/
        var table;
        $(document).ready(function () {
            'use strict';
            table = $("#filesTable").DataTable();
            
            $("button.remove-file").on("click",function(){
            	var that = $(this);
            	var fileId = that.data("file-id");
            	var sampleId = /*[[${sample.id}]]*/ 0;
            	
            	showRemoveFile(fileId, sampleId, $("#file-row-" + fileId));
            });
        });
        
        function showRemoveFile(fileId, sampleId, fileRow) {
        	var urlBase = /*[[@{/samples/ajax/}]]*/ "/samples/ajax/";
        	var removeURL = urlBase + sampleId + "/files/" + fileId;
        	
            noty({
                layout: "center",
                type: "confirmation",
                text: /*[[#{samples.files.remove.confirmation}]]*/ "_Remove sequence file from sample?_",
                modal: true,
                buttons: [
                    {
                        addClass: 'btn btn-primary btn-sm remove-file-confirm', text: [[#{form.btn.confim}]], onClick: function ($noty) {
                        $noty.close();
                    	$.ajax({
                    		url: removeURL,
                    		method: "DELETE",
                    		success: function(){
                    			noty({
                                    text: /*[[#{samples.files.remove.complete}]]*/ '_File removed_',
                                    layout: "topCenter",
                                    type: "success",
                                    timeout: 5000
                                });
                    			table.row(fileRow).remove().draw();
                    		},
                            error: function () {
                                    text: /*[[#{samples.files.remove.error}]]*/ '',
                                noty({
                                    layout: "topCenter",
                                    type: "error",
                                    timeout: 10000
                                })
                            }
                        });
                    }
                    },
                    {
                        addClass: 'btn btn-danger btn-sm', text: [[#{form.btn.cancel}]], onClick: function ($noty) {
                        $noty.close();
                    }
                    }
                ]
            });
        }        
        /*]]>*/
    </script>
</th:block>
</body>
</html>