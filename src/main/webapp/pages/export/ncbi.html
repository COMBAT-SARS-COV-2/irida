<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout" layout:decorator="export/_base">

<head>
  <title th:text="#{project.export.title}"></title>
  <link rel="stylesheet" href="/resources/css/pages/sample_files.css" th:href="@{/resources/css/pages/sample_files.css}" />
</head>

<body>
  <main layout:fragment="main">
    <h1 th:text="#{project.export.title}">_NCBI Export_</h1>
    <div>
      <h2 th:text="${project.label}">_project id_</h2>
    </div>
    <div class="form-group">
      <label class="col-sm-2 control-label">_Metadata_</label>
      <div class="col-sm-10">
        <div class="form-group">
          <label for="bioProject">_BioProject ID_</label>
          <input class="form-control" id="bioProject" />
        </div>
        <div class="form-group">
          <label for="namespace">_SRA Namespace_</label>
          <input class="form-control" id="namespace" />
        </div>
        <div class="form-group">
          <label for="namespace">_Release Date_</label>
          <input class="form-control" type="date" id="release_date" th:with="today=${#dates.createToday()}" th:value="${#calendars.format(today,'YYYY-MM-dd')}"/>
        </div>
      </div>
    </div>
    <div class="form-group">
      <label class="col-sm-2 control-label" th:text="#{project.export.files}">_Files_</label>

      <div class="col-sm-10" th:with="dateFormat=#{locale.date.short}">
        <div class="alert alert-info" role="alert" th:utext="#{project.export.files.description}">_Select files_</div>
        <div th:id="${'sample-' + sample.id}" th:attr="data-sample=${sample.id}" class="sample-container" th:each="sample : ${samples}">
          <h3>
            <a href="#" th:href="@{/projects/{id}/samples/{sid}(id=${project.getId()},sid=${sample.id})}" th:text="${sample.name}"></a>
          </h3>
          <div class="row">
            <form class="metadata-form">
            <div class="col-md-6">
              <div class="form-group">
                <label>_BioSample ID_</label>
                <input class="form-control bioSample" name="bioSample" tooltip="_NCBI BioSample to add files to.  This sample must be created in NCBI before submission._" />
              </div>
              <div class="form-group">
                <label th:text="#{project.export.instrument_model.title}">_Instrument Model_</label>
                <select class="form-control instrument_model" name="instrument_model" th:attr="tooltip=#{project.export.instrument_model.descripton}">
                  <option th:each="instr : ${instrument_model}" th:value="${instr}" th:text="${instr.value}">_Instrument_</option>
                </select>
              </div>
              <div class="form-group">
                <label th:text="#{project.export.library_name.title}">_Library Name_</label>
                <input class="form-control library_name" name="library_name" th:attr="tooltip=#{project.export.library_name.description}"/>
              </div>
              <div class="form-group">
                <label th:text="#{project.export.library_construction_protocol.title}">_Library Construction Protocol_</label>
                <input class="form-control library_construction_protocol" name="library_construction_protocol" th:attr="tooltip=#{project.export.library_construction_protocol.description}"/>
              </div>
            </div>
            <div class="col-md-6">
              <div class="form-group">
                <label th:text="#{project.export.library_strategy.title}">_Library Strategy_</label>
                <select class="form-control library_strategy" name="library_strategy" th:attr="tooltip=#{project.export.library_strategy.description}">
                  <option th:each="sel : ${library_strategy}" th:value="${sel}" th:text="${sel.value}">_Strategy_</option>
                </select>
              </div>
              <div class="form-group">
                <label th:text="#{project.export.library_selection.title}">_Library Selection_</label>
                <select class="form-control library_selection" name="library_selection" th:attr="tooltip=#{project.export.library_selection.description}">
                  <option th:each="sel : ${library_selection}" th:value="${sel}" th:text="${sel.value}">)_Selection_</option>
                </select>
              </div>
              <div class="form-group">
                <label th:text="#{project.export.library_source.title}">_Library Source_</label>
                <select class="form-control library_source" name="library_source" th:attr="tooltip=#{project.export.library_source.description}">
                  <option th:each="sel : ${library_source}" th:value="${sel}" th:text="${sel.value}">)_Source_</option>
                </select>
              </div>

            </div>
            </form>
          </div>
          <th:block th:with="hasPaired=${#maps.containsKey(sample.files, 'paired_end') and #sets.size(sample.files.paired_end) &gt; 0},
								hasSingles=${#maps.containsKey(sample.files, 'single_end') and #sets.size(sample.files.single_end) &gt; 0}">
            <table class="table" th:if="${hasPaired or hasSingles}">

              <!--/* (15-03-26 ) PAIRED END DATA */-->
              <th:block th:if="${hasPaired}" th:with="pairs=${sample.files.paired_end}">
                <th:block th:each="pair : ${pairs}">
                  <tr class="paired_end paired_end__forward">
                    <td class="td_radio" rowspan="2">
                      <!--/* (15-03-26 ) Checked only if it is the first pair in the set. */-->
                      <input type="checkbox" class="paired_files file-checkbox" data-type="paired_end" th:value="${pair.getId()}" th:name="${sample.id}" th:checked="${#sets.contains(newestPairs, pair.getId())}" />
                    </td>
                    <td th:replace="templates/_sequenceFile :: sequenceFileTableLayout (file=${pair.getForwardSequenceFile()},icon='forward', relative='false')"></td>
                  </tr>
                  <tr class="paired_end paired_end__reverse">
                    <td th:replace="templates/_sequenceFile :: sequenceFileTableLayout (file=${pair.getReverseSequenceFile()},icon='reverse')"></td>
                  </tr>
                </th:block>
              </th:block>

              <!--/* (15-03-26 ) SINGLE END DATA */-->
              <th:block th:if="${hasSingles}" th:with="files=${sample.files.single_end}">
                <tr class="single_end" th:each="join : ${files}" th:with="file=${join.getObject()}">
                  <td class="td_radio">
                    <!--/* (15-03-26 ) Checked only if there are no pairs and it is the first one in the file set */-->
                    <input type="checkbox" class="single_files file-checkbox" data-type="single_end" th:value="${file.getId()}" th:name="${sample.id}" th:checked="${#sets.contains(newestSingles, file.getId())}" />
                  </td>
                  <td th:replace="templates/_sequenceFile :: sequenceFileTableLayout (file=${file},icon='single')"></td>
                </tr>
              </th:block>
            </table>

          </th:block>

        </div>
        <button id="submit" class="btn btn-primary" th:text="#{global.btn.submit}">_Submit_</button>

      </div>
    </div>
  </main>
  <th:block layout:fragment="scripts" th:inline="javascript">
    <script>
      $("#submit").click(function() {
        $(this).attr("disabled", "disabled");
        var single = [];
        var paired = [];

        var bioProject = $('#bioProject').val();
        var namespace = $('#namespace').val();
        var release_date = $('#release_date').val();

        var samples = [];

        $(".sample-container").each(function() {
          var sample = $(this);

          var form = sample.find(".metadata-form");

          var data = {};
          var sampleElements = ["bioSample", "instrument_model", "library_name", "library_construction_protocol", "library_strategy", "library_selection", "library_source"];

          var paired = [];
          var single = [];

          _.forEach(sampleElements, function(ele){
            data[ele] = sample.find("."+ele).val();
          });

          sample.find('.paired_files:checked').each(function() {
            paired.push($(this).val());
          });

          $('.single_files:checked').each(function() {
            single.push($(this).val());
          });

          data.single = single;
          data.paired = paired;

          samples.push(data);

        });

        var submission = {
          bioProject: bioProject,
          namespace: namespace,
          release_date: release_date,
          samples: samples
        };

        $.ajax({
          type: "POST",
          url: /*[[@{/projects/{id}/export/ncbi(id=${project.id})}]]*/ '/projects/1/export/ncbi',
          contentType: 'application/json',
          data: JSON.stringify(submission),
          success: function(data, textStatus, jqXHR) {
            var url = /*[[@{/export/submission/}]]*/ '/export/submission/';
            url = url + data.submissionId;
            //window.location = url;
          }
        });
      });

      /*
       * Disable the submit button if nothing is selected
       */
      $(document).ready(function() {
        var fileBoxes = $(".file-checkbox");
        var submitButton = $("#submit");
        disableSubmit(fileBoxes, submitButton);

        fileBoxes.click(function() {
          disableSubmit(fileBoxes, submitButton);
        });
      });

      function disableSubmit(fileBoxes, submitButton) {
        if (fileBoxes.is(":checked")) {
          submitButton.removeAttr("disabled");
        } else {
          submitButton.attr("disabled", "disabled");
        }
      }
    </script>
  </th:block>
</body>

</html>
