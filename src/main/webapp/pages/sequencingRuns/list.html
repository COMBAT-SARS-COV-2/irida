<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
    layout:decorator="sequencingRuns/_base">
<head>
<title th:text="#{sequencingruns.title}">_Clients_</title>
<link rel="stylesheet" th:href="@{/resources/bower_components/angular-busy/angular-busy.css}"
    href="/resources/bower_components/angular-busy/angular-busy.css" />
<script>
	window.dependencies = [ 'SequencingRuns' ];
</script>
</head>
<body>
    <main layout:fragment="main">
    <h1 th:text="#{sequencingruns.title}">_Sequencing runs_</h1>

    <div class="col-md-12" ng-controller="RunsTableCtrl as table">
        <table id="runsTable" class="table ng-cloak">
            <thead>
                <tr ng-controller="SortCtrl as sCtrl">
                    <th id="sortId" th:text="#{iridaThing.id}" sort-by="" onsort="sCtrl.onSort"
                        sortdir="sCtrl.filter.sortDir" sortedBy="sCtrl.filter.sortedBy" sortValue="id">_ID_</th>
                    <th id="sortType" th:text="#{sequencingruns.type}" sort-by="" onsort="sCtrl.onSort"
                        sortdir="sCtrl.filter.sortDir" sortedBy="sCtrl.filter.sortedBy" sortValue="sequencerType">_sequencer_</th>
                    <th id="sortStatus" th:text="#{sequencingruns.uploadStatus}" sort-by="" onsort="sCtrl.onSort"
                        sortdir="sCtrl.filter.sortDir" sortedBy="sCtrl.filter.sortedBy" sortValue="uploadStatus">_sequencer_</th>
                    <th id="sortCreatedDate" th:text="#{iridaThing.timestamp}" sort-by="" onsort="sCtrl.onSort"
                        sortdir="sCtrl.filter.sortDir" sortedBy="sCtrl.filter.sortedBy" sortValue="createdDate">_Created
                        date_</th>
                </tr>
            </thead>
            <tbody>
                <tr class="run-row"
                    ng-repeat="run in table.runs | orderBy: table.filter.sortedBy : table.filter.sortDir | PagingFilter">
                    <td class="run-id"><a class="btn btn-default btn-xs"
                        data:ng-href="@{'/sequencingRuns/{{run.identifier}}'}" href="#">{{run.identifier}}</a></td>
                    <td>{{run.sequencerType}}</td>
                    <td>{{run.uploadStatus}}</td>
                    <td class="createdDate" data-date="{{run.createdDate}}" tooltip-popup-delay='500'
                        tooltip-placement="left" tooltip="{{run.createdDate | date:'medium'}}"><span>{{run.createdDate
                            | date:'mediumDate'}}</span></td>
                </tr>
            </tbody>
            <tfoot>
                <tr>
                    <td colspan="5" class="text-center">
                        <div pagination="" ng-controller="PagingCtrl as paging" ng-model="paging.page"
                            items-per-page="paging.count" total-items="paging.total" ng-change="paging.update()"></div>
                    </td>
                </tr>
            </tfoot>
        </table>

    </div>
    </main>

    <th:block layout:fragment="scripts">
        <script th:src="@{/resources/js/directives/datatables/irida-datatable.js}"
            src="/resources/js/directives/datatables/irida-datatable.js"></script>
        <script th:src="@{/resources/bower_components/angular-busy/angular-busy.js}"
            src="/resources/bower_components/angular-busy/angular-busy.js"></script>

        <script>
            (function(angular, $, _) {
            	function setRootVariable($rootScope) {
            		$rootScope.cgPromise = null;
            	}
            
            	function RunsService($rootScope, R, filter) {
            		var svc = this, base = R.all('sequencingRuns/ajax/list');
            		svc.runs = [];
            
            		svc.getRuns = function() {
            			$rootScope.cgPromise = base.customGET("").then(function(data) {
            				angular.copy(data, svc.runs);
            				$rootScope.$broadcast('RUNS_INIT', {
            					total : data.length
            				});
            			});
            			return svc.runs;
            		}
            
            	}
            
            	function RunsTableCtrl(filter, RunsService) {
            		"use strict";
            		var vm = this;
            		vm.filter = filter;
            		vm.runs = RunsService.getRuns();
            
            	}
            
            	function PagingFilter($rootScope, filter, RunsService) {
            		"use strict";
            		return function(runs) {
            			$rootScope.$broadcast('PAGING_UPDATE', {
            				total : runs.length
            			});
            			var begin = filter.page * filter.count;
            			return runs.slice(begin, begin + filter.count);
            		}
            	}
            
            	function SortCtrl($rootScope, filter) {
            		"use strict";
            		var vm = this;
            		vm.filter = filter;
            
            		vm.onSort = function(sortedBy, sortDir) {
            			vm.filter.sortedBy = sortedBy;
            			vm.filter.sortDir = sortDir;
            			$rootScope.$broadcast('PAGE_CHANGE', {
            				page : 1
            			});
            		}
            	}
            
            	function FilterFactory() {
            		"use strict";
            		return {
            			page : 0,
            			sortDir : true,
            			sortedBy : 'createdDate',
            			count : 10
            		}
            	}
            
            	function PagingCtrl($scope, filter) {
            		"use strict";
            		var vm = this;
            		vm.count = 10;
            		vm.total = 0;
            		vm.page = 1;
            
            		vm.update = function() {
            			filter.page = vm.page - 1;
            		};
            
            		$scope.$on('PAGING_UPDATE', function(e, args) {
            			vm.total = args.total;
            		});
            
            		$scope.$on('PAGE_CHANGE', function(e, args) {
            			vm.page = args.page;
            			vm.update();
            		});
            	}
            
            	function sortBy() {
            		'use strict';
            		return {
            			template : '<a class="clickable" ng-click="sort(sortValue)">'
            					+ '<span ng-transclude=""></span>'
            					+ '<span class="pull-right" ng-show="sortedby == sortvalue">'
            					+ '<i class="fa fa-fw" ng-class="{true: \'fa-sort-asc\', false: \'fa-sort-desc\'}[sortdir]"></i>'
            					+ '</span><span class="pull-right" ng-show="sortedby != sortvalue"><i class="fa fa-sort fa-fw"></i></span></a>',
            			restrict : 'EA',
            			transclude : true,
            			replace : false,
            			scope : {
            				sortdir : '=',
            				sortedby : '=',
            				sortvalue : '@',
            				onsort : '='
            			},
            			link : function(scope) {
            				scope.sort = function() {
            					if (scope.sortedby === scope.sortvalue) {
            						scope.sortdir = !scope.sortdir;
            					} else {
            						scope.sortedby = scope.sortvalue;
            						scope.sortdir = true;
            					}
            					scope.onsort(scope.sortedby, scope.sortdir);
            				};
            			}
            		};
            	}
            
            	angular.module('SequencingRuns', [ 'cgBusy' ])
            	       .run([ '$rootScope', setRootVariable ])
            	       .factory('FilterFactory', [ FilterFactory ])
            			   .service('RunsService', [ '$rootScope', 'Restangular', 'FilterFactory', RunsService ])
            			   .filter('PagingFilter', [ '$rootScope', 'FilterFactory', 'RunsService', PagingFilter ])
            			   .directive('sortBy', [ sortBy ]).controller('PagingCtrl', [ '$scope', 'FilterFactory', PagingCtrl ])
            			   .controller('SortCtrl', [ '$rootScope', 'FilterFactory', SortCtrl ])
            			   .controller('RunsTableCtrl',	[ 'FilterFactory', 'RunsService', RunsTableCtrl ]);
            })(angular, $, _);
								</script>
    </th:block>
</body>
</html>