<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorator="${themePath + '_page'}">
<head>
    <title th:text="${user.label}">_USER PAGE_</title>
    <link rel="stylesheet" th:href="@{/resources/bower_components/magnific-popup/dist/magnific-popup.css}" href="/resources/bower_components/magnific-popup/dist/magnific-popup.css"/>
</head>
<body>
<main layout:fragment="page">
    <div class="col-md-12">
        <div class="row">
            <div class="col-md-12">
                <h1 id="wb-cont" property="name" th:text="${user.label}">__USER NAME__</h1>
            </div>
        </div>
        <div class="row">
            <!-- User details -->
            <div class="col-md-6">
                <div class="panel panel-primary">
                    <div class="panel-heading clearfix">
                        <h3 class="panel-title pull-left" th:text="#{user.details}">_User Details_</h3>

                        <div class="btn-group-xs pull-right">
                            <a href="#password-reset-modial" sec:authorize="hasAnyRole('ROLE_ADMIN','ROLE_MANAGER')"
                               class="btn btn-default password-reset-link" th:text="#{user.passwordReset}">_Password
                                Reset_</a>
                            <a id="editUser" class="btn btn-default " th:if="${canEditUser}"
                               th:href="@{/users/{id}/edit(id=${user.id})}" href="/users/1/edit"
                               th:text="#{user.edit}"></a>
                        </div>
                    </div>

                    <div class="panel-body">
                        <ul class="nav nav-pills nav-stacked project-details" th:inline="text">
                            <li>
                                <i class="glyphicon glyphicon-barcode"></i>&nbsp;[[#{users.id}]]
                    		<span class="pull-right" id="user-id"
                                  th:text="${user.id}">_USER_ID_</span>
                            </li>
                            <li>
                                <i class="glyphicon glyphicon-user"></i>&nbsp;[[#{users.username}]]
                    		<span class="pull-right" id="user-username"
                                  th:text="${user.username}">_USERNAME_</span>
                            </li>
                            <li>
                                <i class="glyphicon glyphicon-tag"></i>&nbsp;[[#{user.name}]]
                    		<span class="pull-right" id="user-name"
                                  th:text="${user.label}">_NAME_</span>
                            </li>
                            <li>
                                <i class="glyphicon glyphicon-envelope"></i>&nbsp;[[#{users.email}]]
                    		<span class="pull-right">
                    			<a th:href="'mailto:'+${user.email}" href="mailto:someone@nowhere.com">
                                    <span id="user-email" th:text="${user.email}">_EMAIL_</span>
                                </a>
                    		</span>
                            </li>
                            <li>
                                <i class="glyphicon glyphicon-earphone"></i>&nbsp;[[#{user.phone}]]
                    		<span class="pull-right" id="user-phone"
                                  th:text="${user.phoneNumber}">_123-456-7890_</span>
                            </li>
                            <li>
                                <i class="glyphicon glyphicon-stats"></i>&nbsp;[[#{users.role}]]
                    		<span class="pull-right" id="user-role"
                                  th:text="${systemRole}">_ROLE_</span>
                            </li>
                            <li>
                                <i class="glyphicon glyphicon-off"></i>&nbsp;[[#{user.enabled}]]
                                <span class="pull-right glyphicon glyphicon-ok" th:if="${user.enabled}"></span>
                                <span class="pull-right glyphicon glyphicon-remove" th:if="not ${user.enabled}"></span>
                            </li>
                            <li>
                                <i class="glyphicon glyphicon-calendar"></i>&nbsp;[[#{user.created}]]
                        	<span class="pull-right" id="user-created"
                                  th:text="${#calendars.format(user.createdDate, 'dd MMM yyyy')}">_DATE_CREATED_</span>
                            </li>
                            <li>
                                <i class="glyphicon glyphicon-calendar"></i>&nbsp;[[#{user.modified}]]
                        	<span class="pull-right" id="user-modified"
                                  th:text="${#calendars.format(user.modifiedDate, 'dd MMM yyyy')}">__DATE_CREATED__</span>
                            </li>
                        </ul>
                    </div>
                </div>
            </div>

            <!-- User project table -->
            <div class="col-md-6 ">
                <div class="panel panel-info">
                    <div class="panel-heading clearfix">
                        <h3 class="panel-title pull-left" th:text="#{user.projects.title}">_Projects_</h3>
                        <span class="pull-right" th:text="#{user.projects.view} + ' (' + ${totalProjects} + ')'">_View All (10)_</span>
                    </div>

                    <div class="panel-body">
                        <table id="projectsTable" class="table table-striped table-hover">
                            <thead>
                            <tr>
                                <th th:text="#{user.projects.id}">_ID_</th>
                                <th th:text="#{user.projects.name}">_NAME_</th>
                                <th th:text="#{user.projects.role}">_ROLE_</th>
                                <th th:text="#{user.projects.dateAdded}">_DATE_</th>
                            </tr>
                            </thead>
                            <tbody>
                            <tr th:each="project,iterStat : ${projects}">
                                <td class="user-project-id" th:text="${project.subject.id}">_PROJECT_ID_</td>
                                <td class="user-project-name"><a
                                        th:href="@{/projects/{projectId}(projectId=${project.subject.id})}"><span
                                        th:text="${project.subject.name}">_PROJECT_NAME_</span></a></td>
                                <td class="user-project-role">
                                    <span class="project-role-icon"></span>&nbsp;
                    				<span class="project-role-name" th:title="${project.projectRole}"
                                          th:text="${projectRoles[iterStat.index]}">
                    					_PROJECT_ROLE_
                    				</span>
                                </td>
                                <td class="user-project-date"
                                    th:text="${#calendars.format(project.createdDate, 'dd MMM yyyy')}">_DATE ADDED_
                                </td>
                            </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <section id="password-reset-modial" class="modal-dialog modal-content overlay-def mfp-hide">
            <header class="modal-header">
                <h2 class="modal-title" id="lbx-title" th:text="#{user.passwordReset}">_Reset Password_</h2>
            </header>
            <div class="modal-body">
                <p th:text="#{user.passwordReset.modial(${user.label})}">_Reset user's password?_</p>
            </div>
            <div class="panel-footer text-right">
                <button class="btn btn-default popup-modal-dismiss" th:text="#{user.passwordReset.cancel}">_Cancel_
                </button>
                <button id="resetPasswordButton" class="btn btn-primary popup-modal-dismiss"
                        th:text="#{user.passwordReset.confirm}">_Confirm_
                </button>
            </div>
        </section>
    </div>

</main>
<th:block layout:fragment="page-scripts" th:inline="javascript">
    <!-- Add the project role icons to the project role names -->
    <script th:src="@{/resources/bower_components/magnific-popup/dist/jquery.magnific-popup.min.js}"
            src="/resources/bower_components/magnific-popup/dist/jquery.magnific-popup.min.js"></script>
    <script th:src="@{/resources/bower_components/noty/js/noty/packaged/jquery.noty.packaged.min.js}"   
            src="/resources/bower_components/noty/js/noty/packaged/jquery.noty.packaged.min.js"></script>
    <script th:inline="javascript">
        $(document).ready(function () {
            //set up an array of the role names mapping to their icons
            var roleClass = [];
            roleClass["PROJECT_USER"] = "glyphicon glyphicon-user";
            roleClass["PROJECT_OWNER"] = "glyphicon glyphicon-tower";

            //add the icon if it exists
            $('#projectsTable').find(".user-project-role").each(function (index, element) {
                var iconSpan = $(element).find(".project-role-icon");
                var rolename = $(element).find(".project-role-name").attr("title");
                if (roleClass[rolename]) {
                    iconSpan.addClass(roleClass[rolename]);
                }
            });

            //Set modial popup links
            $('.password-reset-link').magnificPopup({
                type: 'inline'
            });

            //Confirm password click
            $("#resetPasswordButton").click(function () {
                var id = [[${user.id}]];
                var url = [[@{
                    /password_reset/
                    ajax / create /
                }
                ]]
                +id;
                $.ajax({
                    url: url,
                    success: function () {
                        noty({
                            text: [[#{user.passwordReset.success}]],
                            layout: "topCenter",
                            type: "success",
                            timeout: 5000
                        })
                    },
                    error: function () {
                        noty({
                            text: [[#{user.passwordReset.error}]],
                            layout: "topCenter",
                            type: "error",
                            timeout: false
                        })
                    }
                });
            });
            
            $('.popup-modal-dismiss').click(function (e) {
        		$.magnificPopup.close();
        	});

        });
    </script>
</th:block>
</body>
</html>