<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorator="template/page">
<head lang="en">
	<title th:text="#{pipeline.phylogenomics.page-title}">Pipelines - Launch</title>
	<link rel="stylesheet" href="/resources/css/pages/pipelines.css" th:href="@{/resources/css/pages/pipelines.css}"/>
	<style>
		.affix-top {
			position: fixed;
			top: 50px;
			max-width: 100px;
		}
	</style>
	<script>window.dependencies = ['irida.pipelines.phylogenomics'];</script>
</head>
<body>
<div layout:fragment="page" ng-app="irida.pipelines.phylogenomics">
	<form class="form-horizontal" method="post" ng-controller="PhylogenomicsController as phylCtrl">
		<div id="no-ref-warning" class="row" th:if="${#lists.size(referenceFiles)} == 0">
			<h1 th:text="#{workflow.phylogenomics.title}"></h1>

			<div class="alert alert-danger col-md-12">
				<b th:text="#{pipeline.phylogenomics.no-reference-heading}">The Phylogenomics Pipeline Requires a
					reference file to run.</b><br/><br/>
				<th:block th:if="${#lists.size(addRefProjects) > 0}">
					<p id="has-rights" th:text="#{pipeline.phylogenomics.no-reference.link-heading}">Projects You can
						Upload a Reference File to:</p>
					<ul class="nav nav-pills nav-stacked col-md-3">
						<li th:each="project : ${addRefProjects}">
							<a class="add-ref-file" th:href="@{/projects/{id}/referenceFiles(id=${project.id})}"
							   href="#" th:text="${project.name}"></a>
						</li>
					</ul>
				</th:block>
				<th:block th:if="${#lists.size(addRefProjects)} == 0">
					<p id="has-no-rights" th:text="#{pipeline.phylogenomics.no-reference.no-permissions}">You do not
						have permission to upload a reference file to these projects. Please contact a project manager
						to add a reference file.</p>
				</th:block>
			</div>
		</div>
		<div class="row" th:if="${#lists.size(referenceFiles)} &gt; 0">
			<div class="col-md-10">
				<h1 th:text="#{workflow.phylogenomics.title}"></h1>

				<div class="alert alert-info">
					<div class="form-group">
						<label class="col-sm-2 control-label" for="pipeline-name"
						       th:text="#{workflow.label.name}">Name</label>

						<div class="col-md-10">
							<input id="pipeline-name" class="form-control" type="text" th:value="${name}"/>

							<div ng-show="phylCtrl.error" class="label label-danger">{{phylCtrl.error}}</div>
						</div>
					</div>
					<div class="form-group">
						<label for="referenceFiles" class="col-sm-2 control-label"
						       th:text="#{workflow.label.reference-file}">Reference File</label>

						<div class="col-sm-10">
							<select class="form-control" name="referenceFiles" id="referenceFiles">
								<option th:each="ref : ${referenceFiles}" th:value="${ref.file.getId()}"
								        data:project="${ref.project.id}"
								        th:text="${ref.file.getLabel() + ' (' + ref.project.getLabel() + ')'}"></option>
							</select>
						</div>
					</div>
				</div>

				<div class="form-group alert">
					<label class="col-sm-2 control-label" th:text="#{workflow.label.files}">Files</label>

					<div class="col-sm-10">
						<div th:each="project : ${files}">
							<div class="sample-container" th:each="sample : ${project.samples}">
								<h3>
									<a href="#" th:href="@{/projects/{id}/samples(id=${project.id})}"
									   th:text="${project.name + ' / ' + sample.name}"></a>
									<button type="button" class="btn btn-xs btn-default pull-right remove"
									        th:text="#{form.btn.remove}">Remove
									</button>
								</h3>
								<table class="table" th:with="dateFormat=#{locale.date.long}">
									<th:block th:each="s, iterStat : ${sample.files}">
										<tr th:if="${s.type == 'paired_end'}">
											<td>
												<div class="layout-flex">
													<div class="file_checkbox paired_end">
														<input th:name="${sample.id}" type="radio" data:type="${s.type}"
														       th:checked="${iterStat.first}" th:value="${s.id}"/></div>
													<div class="file_names">
														<div data:file="${file.id}" th:each="file : ${s.files}"
														     th:text="${file.label}"></div>
													</div>
													<div class="file_date">
														<div
															th:text="${#dates.format(s.createdDate, dateFormat)}"></div>
													</div>
												</div>
											</td>
										</tr>
										<tr th:if="${s.type == 'single_end'}">
											<td>
												<div class="layout-flex">
													<div class="file_checkbox single_end">
														<input th:name="${sample.id}" data:type="${s.type}"
														       data:sample="${sample.id}" type="radio"
														       th:value="${s.id}" th:checked="${iterStat.first}"/>
													</div>
													<div class="file_names">
														<div th:text="${s.label}"></div>
													</div>
													<div class="file_date">
														<div
															th:text="${#dates.format(s.createdDate, dateFormat)}"></div>
													</div>
												</div>
											</td>
										</tr>
									</th:block>
								</table>
							</div>
						</div>
					</div>
				</div>
			</div>
			<div class="col-md-2" ng-switch="phylCtrl.loading">
				<div data-spy="affix" style="width: 200px;">
					<div ng-switch-when="false" class="ng-cloak text-center">
					<h2 th:text="#{workflow.launch.btn}">Ready to Launch?</h2>
						<div>
							<button id="btn-launch" class="btn btn-xl btn-danger btn-action" th:title="#{workflow.launch.btn.title}"
							        ng-click="phylCtrl.launch()">
								<span class="fa fa-rocket"></span>
							</button>
						</div>
					</div>
					<div id="pipeline-submitted" ng-switch-when="true">
						<div ng-hide="phylCtrl.success" class="alert alert-info">
							<strong class="fa fa-2x fa-fw fa-coffee"></strong>&nbsp;
							<span th:text="#{workflow.pipeline-kickoff-message}"></span>
						</div>
						<div id="pipeline-submitted-success" ng-show="phylCtrl.success" class="alert alert-success">
							<strong class="fa fa-2x fa-smile-o text-center"></strong>&nbsp;
							<span th:text="#{workflow.submitted-success}">You must be awesome!  All your files looked good and the pipeline has been launched and the pedal should hit the metal soon.</span>
							<br/><br/>
							<button id="btn-see-pipeline" class="btn btn-success btn-affixed" th:text="#{workflow.submitted-view-btn}">Let's see how this pipeline is doing.</button>
							<br/><br/>
							<button id="btn-clear-pipeline" class="btn btn-warning btn-affixed" th:text="#{workflow.submitted-clear-btn}">Clear the cart and start over!</button>
						</div>
					</div>
				</div>
			</div>
		</div>
	</form>
</div>
<th:block layout:fragment="page-scripts">
	<script th:inline="javascript">
		/*<![CDATA[*/
		var PIPELINE = {
			url     : /*[[@{/pipelines/ajax/start/{id}(id=${pipelineId})}]]*/ '/ajax/pipelines/ccca532d-b0be-4f2c-bd6d-9886aa722571',
			redirect: /*[[@{/analysis/admin}]]*/ '/analysis/admin', // TODO: This should be the page for this specific pipeline.
			required: /*[[#{workflow.no-name-provided}]]*/ 'Name Required'
		};
		/*]]>*/
	</script>
	<script src="/resources/bower_components/bootstrap/js/affix.js"
	        th:src="@{/resources/bower_components/bootstrap/js/affix.js}"></script>
	<script src="/resources/js/pages/pipelines/phylogenomics.js"
	        th:src="@{/resources/js/pages/pipelines/phylogenomics.js}"></script>
</th:block>
</body>
</html>