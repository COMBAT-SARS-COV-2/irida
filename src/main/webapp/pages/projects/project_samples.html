<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorator="projects/_base">
<head>
    <title th:text="${project.label} + ' - ' + #{project.nav.samples}"></title>
    <link rel="stylesheet" th:href="@{/resources/bower_components/select2/select2.css}"
          href="/resources/bower_components/select2/select2.css"/>
    <link rel="stylesheet" th:href="@{/resources/bower_components/select2/select2-bootstrap.css}"
          href="/resources/bower_components/select2/select2-bootstrap.css"/>
    <link rel="stylesheet" th:href="@{/resources/bower_components/DataTables/media/css/jquery.dataTables.min.css}"
          href="/resources/bower_components/DataTables/media/css/jquery.dataTables.min.css"/>
    <link rel="stylesheet" th:href="@{/resources/bower_components/magnific-popup/dist/magnific-popup.css}"
          href="/resources/bower_components/magnific-popup/dist/magnific-popup.css"/>
</head>
<body>
<main layout:fragment="main">
    <div class="row">
        <div class="col-md-12">
            <h1 role="heading"
                th:text="#{project.samples.h1(${project.label})}">__PAGE_TITLE__</h1>
        </div>
    </div>
    <div class="row mrgn-bttm-md">
        <div class="col-md-12">
            <div class="btn-toolbar mrgn-bttm-md" role="toolbar" th:inline="text">
                <div class="btn-group">
                    <button id="deleteBtn" class="btn btn-default btn-sm btn-action" disabled="true">
                        <span class="fa fa-trash-o fa-fw"></span>&nbsp;[[#{project.samples.delete}]]
                    </button>
                </div>
                <div class="btn-group">
                    <button id="copyBtn" class="btn btn-default btn-sm btn-action" disabled="true">
                        <span class="fa fa-copy fa-fw"></span>&nbsp;[[#{project.samples.copy}]]
                    </button>
                </div>
                <div th:if="${isOwner} or ${isAdmin}" class="btn-group">
                    <button id="moveBtn" class="btn btn-default btn-sm btn-action" disabled="true">
                        <span class="fa fa-truck fa-fw"></span>&nbsp;[[#{project.samples.move}]]
                    </button>
                </div>
                <div class="btn-group">
                    <button id="combineBtn" class="btn btn-default btn-sm btn-action2" disabled="true">
                        <span class="fa fa-compress fa-fw"></span>&nbsp;[[#{project.samples.combine}]]
                    </button>
                </div>
                <div class="btn-group">
                    <button id="runPipelineBtn" aria-controls="runPipelineModal"
                            class="btn btn-primary btn-sm btn-action3" role="button" disabled="true">
                        <span class="fa fa-rocket fa-fw"></span>&nbsp;[[#{project.samples.run-pipeline}]]
                    </button>
                </div>
            </div>
        </div>
    </div>
    <div class="row">
        <div class="col-md-12">
            <table id="samplesTable" class="table table-striped">
                <thead>
                <tr role="row" th:inline="text">
                    <th data:tooltip="#{tooltip.selectall-none}"><input type="checkbox" id="selectAll"/></th>
                    <th id="sampleNameHeader" class="sortable">[[#{project.samples.table.name}]]</th>
                    <th id="sampleNumFilesHeader">[[#{project.samples.table.numFiles}]]</th>
                    <th id="sampleDateCreatedHeader" class="sortable">[[#{project.samples.table.dateCreated}]]</th>
                </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>
    </div>
</main>

<th:block layout:fragment="scripts" th:inline="javascript">
<script th:src="@{/resources/bower_components/DataTables/media/js/jquery.dataTables.min.js}"
        src="/resources/bower_components/DataTables/media/js/jquery.dataTables.min.js"></script>
<script th:src="@{/resources/bower_components/select2/select2.min.js}"
        src="/resources/bower_components/select2/select2.min.js"></script>
<script th:src="@{/resources/bower_components/magnific-popup/dist/jquery.magnific-popup.min.js}"
        src="/resources/bower_components/magnific-popup/dist/jquery.magnific-popup.min.js"></script>
<script th:src="@{/resources/bower_components/mustache/mustache.js}"
        src="/resources/bower_components/mustache/mustache.js"></script>
<script th:src="@{/resources/bower_components/noty/js/noty/packaged/jquery.noty.packaged.min.js}"
        src="/resources/bower_components/noty/js/noty/packaged/jquery.noty.packaged.min.js"></script>

<section id="runPipelineModal" class="white-popup form-popup mfp-hide" th:inline="text">
    <header class="modal-header">
        <h2 class="modal-title" th:text="#{project.samples.run-modal.title}">__Select_Pipeline__</h2>
    </header>
    <div class="modal-body">
        <div class="form-group">
            <label for="pipeline" th:text="#{samples.pipeline-select}">Select a Pipeline</label>
            <input id="pipeline" name="pipeline" class="form-control input-full"/>
        </div>
        <div class="form-group">
            <label for="reference" th:text="#{samples.pipeline-reference}">Select a Reference File</label>
            <input id="reference" name="reference" class="form-control input-full"/>
        </div>
        <div class="form-group">
            <label for="name" th:text="#{project.samples.run-modal.name}">Name for Pipeline</label>
            <input type="text" id="name" name="name" class="form-control input-full" required="required"
                   th:placeholder="#{form.required}"/>
            <section id="name-error" class="alert alert-danger hidden">
                <p th:text="#{pipelines.state.name-missing}">Pipeline name is required.</p>
            </section>
        </div>
    </div>
    <div class="modal-footer">
        <button id="launchBtn" class="btn btn-primary btn-sm"><span class="fa fa-rocket fa-fw"></span>&nbsp;[[#{project.samples.run-pipeline}]]
        </button>
    </div>
</section>
<script type="text/html" id="copySamplesSection">
    <h2 id="copyTitle">_Copy/Move Samples_</h2>

    <input type="text" id="copy-sample-project" name="project" class="form-control input-full"/>
    <span id="copy-samples-error" class="help-block bg-danger"></span>
</script>
<script type="x-tmpl-mustache" id="files-view-template">
        <tr id="files-view">
            <td colspan="5">
            <table>
                {{#files}}
                <tr>
                    <td>
                    {{#checked}}
                    <input class="fileCB" data-sample-id="{{sampleId}}" data-file-id="{{id}}" type="checkbox" checked="checked" />
                    {{/checked}}
                    {{#notChecked}}
                    <input class="fileCB" data-sample-id="{{sampleId}}" data-file-id="{{id}}" type="checkbox" />
                    {{/notChecked}}
                    </td>
                    <td class="files-name">
                        <a th:href="@{/sequenceFiles/{{id}}}">{{label}}</a>
                    </td>
                    <td><button data-file-id="{{id}}" class="filedownload pull-right btn btn-default btn-xs glyphicon glyphicon-download-alt mrgn-rght-sm" th:title="#{form.download}"></button></td>
                    <td>{{size}}</td>
                    <td>{{createdDate}}</td>
                </tr>
                {{/files}}
            </table>
            </td>
		</tr>



</script>
<script type="text/html" id="select2-merge">
    <h2 th:text="#{project.samples.combine-title}">__REMOVED_TITLE__</h2>
    <p th:text="#{project.samples.combine-warning}"></p>
    <div class="form-group">
        <input class="input-full" name="merge-name" type="text" id="select2-merge-input"/>
        <span id="merge-error" class="hidden help-block bg-danger"></span>
    </div>
</script>
<iframe id="invisible" style="display:none;"></iframe>
<script th:inline="javascript">
/*<![CDATA[*/
/*
 Add functionality to the string object to be able to template out a string.
 e.g. "fred {0}".format("flintstone") --> "fred flintstone"
 */
if (!String.prototype.format) {
    String.prototype.format = function () {
        var args = arguments;
        return this.replace(/{(\d+)}/g, function (match, number) {
            return typeof args[number] != 'undefined'
                    ? args[number]
                    : match
                    ;
        });
    };
}
function EditableDataTable() {
    this.selectedRowIds = [];
    this.allRowIds = [];
    this._dataTable = null;
    this.totalSamples = 0;

    function createEditForm(name) {
        var form = document.createElement("form");
        form.setAttribute("role", "form");
        form.className = "form-inline";

        var group = document.createElement("div");
        group.className = "form-group";
        form.appendChild(group);

        var input = document.createElement("input");
        input.setAttribute('type', 'text');
        input.id = "editName";
        input.className = "form-control input-sm mrgn-rght-sm";
        input.setAttribute('placeholder', name);
        group.appendChild(input);

        var btn = document.createElement("button");
        btn.className = "btn btn-sm btn-primary submit";
        btn.innerHTML = /*[[#{form.btn.update}]]*/ "Update"
        group.appendChild(btn);

        return form;
    }

    function undoRename(sampleId, origName) {
        var that = this;
        $.ajax({
            url: /*[[@{/projects/ajax/{projectId}/samples/update(projectId=${project.getId()})}]]*/ '/projects/ajax/update',
            type: 'post',
            data: {'sampleId': sampleId, 'name': origName}
        }).done(function () {
            this.updateTable();
        });
    }

    function deleteSamples(table, noty) {
        $.ajax({
            url: /*[[@{/projects/ajax/{projectId}/samples/delete(projectId=${project.getId()})}]]*/ "/projects/ajax/{projectId}/samples/delete",
            type: "POST",
            data: "sampleIds=" + table.selectedRowIds
        }).done(function (data) {
            table.updateTable();
            table.getAllSampleIds();
            table.selectedRowIds = [];
            noty.close();
            var msg = /*[[#{project.samples.remove-success}]]*/ 'Samples successfully removed from project';
            showSuccessModal(msg);
        });
    }

    function copySamples(table, noty, newProject, removeFromOriginal) {
        $.ajax({
            url: /*[[@{/projects/ajax/{projectId}/samples/copy(projectId=${project.getId()})}]]*/ '/projects/ajax/1/samples/copy',
            data: "sampleIds=" + table.selectedRowIds + "&newProjectId=" + newProject + "&removeFromOriginal=" + removeFromOriginal,
            type: "post",
            success: function (data) {
                noty.close();
                var msg;
                if (removeFromOriginal) {
                    msg = /*[[#{project.samples.move-success}]]*/ 'Samples successfully move';
                }
                else {
                    msg = /*[[#{project.samples.copy-success}]]*/ 'Samples successfully copied';
                }
                var count = data.totalCopied;
                if (count > 0) {
                    showSuccessModal(msg.format(count));
                }
                if (data.warnings) {
                    for (warning in data.warnings) {
                        var warnmsg = /*[[#{project.samples.copy.sample-exists}]]*/ 'Sample exists in project';

                        showWarningModial(warnmsg.format(data.warnings[warning]));
                    }
                }
                table.selectedRowIds = [];
                table.updateTable();
                table.getAllSampleIds();
            },
            error: function () {
                console.log(data.error);
            }
        });
    }

    function combineSamples(table, noty, nameId, newName) {
        $.ajax({
            url: /*[[@{/projects/ajax/{projectId}/samples/merge(projectId=${project.getId()})}]]*/ '/projects/ajax/1/samples/merge',
            data: "sampleIds=" + table.selectedRowIds + "&mergeSampleId=" + nameId + "&newName=" + newName,
            type: "post"
        }).done(function (data) {
            if (data.success) {
                noty.close();
                var msg = /*[[#{project.samples.combine-success}]]*/ 'Samples successfully merged samples';
                showSuccessModal(msg.format(table.selectedRowIds.length, data.success));
                table.selectedRowIds = [];
                table.updateTable();
                table.getAllSampleIds();
                $("#merge-error").addClass('hidden');
            } else {
                $("#merge-error").html(data.error.sampleName).removeClass('hidden');
            }
        });
    }

    function showSuccessModal(message) {
        noty({
            text: message,
            layout: "topCenter",
            type: "success",
            timeout: 3200
        });
    }

    function showErrorModal(message) {
        noty({
            text: message,
            layout: "topCenter",
            type: "error",
            timeout: 3200
        });
    }

    function showWarningModial(message) {
        noty({
            text: message,
            layout: "topCenter",
            type: "warning",
            timeout: 10000
        });
    }

    this._closeDetailsView = function () {
        $("tr.details")
                .removeClass('details')
                .next().remove();
    };

    this._openDetailsView = function (row) {
        var that = this,
                $row = $(row),
                checkbox = $row.find('.sampleCB'),
                sampleId = checkbox.val(),
                indeterminate = checkbox.prop('indeterminate'),
                selected = checkbox.prop('checked'),
                url = /*[[@{/samples/ajax/{0}/files}]]*/ '/samples/ajax/1/files';
        $.ajax({
            'url': url.format(sampleId),
            'type': 'post'
        }).done(function (data) {
            var selectedFiles = {};
            if (data.length > 0) {
                // sampleCB not selected
                if (selected) {
                    $.each(data, function (i, v) {
                        v.checked = true
                    })
                } else if (indeterminate) {
                    var omitted = that.allRowIds[sampleId].omit;
                    $.each(data, function (i, v) {
                        if (omitted.indexOf(v.id) === -1) {
                            v.checked = true;
                        }
                        else {
                            v.notChecked = true;
                        }
                    });
                }
                else {
                    $.each(data, function (i, v) {
                        v.notChecked = true
                    })
                }

                var template = $('#files-view-template').html();
                var content = Mustache.render(template, {
                    files: data,
                    sampleId: sampleId
                });
                $row.addClass('details').after(content);
            } else {
                var msg = /*[[#{project.samples.files.not-available}]]*/ 'Cannot get file information right now';
                showErrorModal(msg);
            }
        });
    };

    this._showDeleteSampleModal = function () {
        var that = this;
        var result = true;
        noty({
            layout: "center",
            type: "warning",
            text: /*[[#{project.samples.remove-warning}]]*/ "You are about to delete samples.",
            modal: true,
            buttons: [
                {
                    addClass: 'btn btn-primary btn-sm',
                    text: /*[[#{form.btn.confim}]]*/ 'OK',
                    onClick: function ($noty) {
                        deleteSamples(that, $noty);
                    }
                },
                {
                    addClass: 'btn btn-default btn-sm',
                    text: /*#{form.btn.cancel}*/ 'Cancel',
                    onClick: function ($noty) {
                        $noty.close();
                        result = false;
                    }
                }
            ]
        });
        return result;
    };

    this._showCopySamplesModial = function (removeFromCurrentProject) {
        var that = this;
        var div = document.getElementById('copySamplesSection');
        var template = div.innerHTML;
        $("#copy-samples-error").hide();
        noty({
            layout: "center",
            type: "default",
            text: template,
            modal: true,
            buttons: [
                {
                    addClass: 'btn btn-primary btn-sm',
                    text: /*[[#{form.btn.confim}]]*/ 'OK',
                    onClick: function ($noty) {
                        var newProject = $("#copy-sample-project").val();

                        if (newProject) {
                            copySamples(that, $noty, newProject, removeFromCurrentProject);
                        }
                        else {
                            var noProject = /*[[#{project.samples.copy.no-project-selected}]]*/ 'No project selected';

                            $("#copy-samples-error").html(noProject);
                            $("#copy-samples-error").show();
                        }
                    }
                },
                {
                    addClass: 'btn btn-default btn-sm',
                    text: /*#{form.btn.cancel}*/ 'Cancel',
                    onClick: function ($noty) {
                        $noty.close();
                    }
                }
            ],
            callback: {
                onShow: function () {
                    //get the available projects
                    $("#copy-sample-project").select2({
                        ajax: {
                            url: /*[[@{/projects/ajax/{id}/samples/available_projects(id=${project.getId()})}]]*/ '/projects/ajax/1/samples/available_projects',
                            dataType: 'json',
                            data: function (search, page) {
                                return {
                                    term: search, // search term
                                    page: page - 1, //zero based method
                                    pageSize: 10,
                                };
                            },
                            results: function (data, page) {
                                var results = [];

                                var more = (page * 10) < data.total;

                                for (var id in data.results) {
                                    results.push({
                                        "id": id,
                                        "text": data.results[id]
                                    });
                                }

                                return {results: results, more: more};
                            }
                        },
                        dropdownCss: {"z-index": 10000001},
                        "placeholder": /*[[#{project.samples.copy.select-project}]]*/ "Select a Project"
                    });
                }
            }
        });
    };

    this._showCombineSamplesModal = function () {
        var that = this;
        // TODO: get ajax list of samples names from server.
        $.ajax({
            url: "/projects/ajax/getNamesFromIds",
            type: "post",
            data: "sampleIds=" + this.selectedRowIds
        }).done(function (data) {
            var div = document.getElementById('select2-merge');
            var template = div.innerHTML;
            noty({
                layout: "center",
                type: "default",
                text: template,
                modal: true,
                buttons: [
                    {
                        addClass: 'btn btn-primary btn-sm',
                        text: /*[[#{form.btn.confim}]]*/ 'OK',
                        onClick: function ($noty) {
                            var mergeSampleId = $("#select2-merge-input").val();
                            var newName = "";
                            if (that.selectedRowIds.indexOf(mergeSampleId) === -1) {
                                newName = mergeSampleId;
                                mergeSampleId = "";
                            }

                            combineSamples(that, $noty, mergeSampleId, newName);
                        }
                    },
                    {
                        addClass: 'btn btn-default btn-sm',
                        text: /*#{form.btn.cancel}*/ 'Cancel',
                        onClick: function ($noty) {
                            $noty.close();
                        }
                    }
                ],
                callback: {
                    onShow: function () {
                        $("#select2-merge-input").select2({
                            data: data,
                            dropdownCss: {"z-index": 10000001},
                            createSearchChoice: function (term, data) {
                                if ($(data).filter(function () {
                                            return 0 === this.text.localeCompare(term);
                                        }).length === 0) {
                                    return {id: term, text: term};
                                }
                            }
                        });
                    }
                }
            });
        });
    }
}

EditableDataTable.prototype = {
    updateTable: function () {
        this._dataTable.ajax.reload();
    },
    getAllSampleIds: function () {
        var that = this;
        $.ajax({
            url: /*[[@{/projects/ajax/{projectId}/samples/getids(projectId=${project.getId()})}]]*/ "/ajax/1/samples/getids",
        }).done(function (data) {
            if (data.ids) {
                that.totalSamples = data.ids.length;
                $(".navbar li.active span.badge").html(data.ids.length);
                that.allRowIds = {};
                $.each(data.ids, function (id, val) {
                    that.allRowIds[val] = {id: val, selected: false, omit: []};
                });
            }
        });
    },
    setDataTable: function (table) {
        this._dataTable = table;
    },
    getRowState: function (id) {
        if (this.selectedRowIds.indexOf(id) == -1) {
            return "";
        }
        else {
            return " checked='checked'"
        }
    },
    updateAllSelected: function (isAllSelected) {
        var that = this;
        this.selectedRowIds = [];
        if (isAllSelected) {
            $.each(that.allRowIds, function (i, val) {
                that.selectedRowIds.push(val.id)
                val.omit = [];
            });
        }
    },
    checkBoxClickedEvent: function (id, checked) {
        var index = this.selectedRowIds.indexOf(id);
        this.allRowIds[id].omit = [];
        if (checked) {
            if (index === -1) {
                this.selectedRowIds.push(id)
            }
        }
        else {
            this.selectedRowIds.splice(index, 1);
        }
    },
    toggleFilesView: function (el) {
        var openRow = $("#samplesTable").find('.details'),
                isSame = el.find('input[type="checkbox"]').val() === openRow.find('input[type="checkbox"]').val();
        if (openRow.length === 1) {
            this._closeDetailsView();
        }
        if (!isSame) {
            this._openDetailsView(el);
        }
    },
    getSelectAllState: function () {
        var result = "indeterminate";
        if (this.selectedRowIds.length === 0) {
            return false; // Checkbox unchecked
        } else if (this.selectedRowIds.length === this.totalSamples) {
            // Need to see if there are any files omitted!
            result = true;
            $.each(this.allRowIds, function (i, v) {
                if (v.omit.length > 0) {
                    result = "indeterminate"
                }
            });
        }
        else {
            result = "indeterminate"
        }
        return result; // Checkbox indeterminant
    },
    deleteSelectedSamples: function () {
        if (this.selectedRowIds.length > 0) {
            this._showDeleteSampleModal();
        }
    },
    combineSelectedSamples: function () {
        if (this.selectedRowIds.length > 0) {
            this._showCombineSamplesModal();
        }
    },
    copySelectedSamples: function (removeFromCurrentProject) {
        if (this.selectedRowIds.length > 0) {
            var title;
            if (removeFromCurrentProject) {
                title = /*[[#{project.samples.move.title}]]*/ "Move Samples";
            }
            else {
                title = /*[[#{project.samples.copy.title}]]*/ "Copy Samples";
            }

            this._showCopySamplesModial(removeFromCurrentProject);
            $("#copyTitle").html(title);
        }
    }
};

$(document).ready(function () {
    var $deleteBtn = $("#deleteBtn"),
            $btnAction = $(".btn-action"),
            $btnAction2 = $(".btn-action2"),
            $btnAction3 = $(".btn-action3"),
            $combineBtn = $("#combineBtn"),
            $copyBtn = $("#copyBtn"),
            $moveBtn = $("#moveBtn"),
            $selectAll = $("#selectAll"),
            $samplesTable = $('#samplesTable'),
            DT = new EditableDataTable();

    DT.setDataTable($samplesTable.DataTable({
        dom: "<'top'lf>rt<'bottom'ip><'clear'>",
        processing: true,
        serverSide: true,
        deferRender: true,
        ajax: /*[[@{/projects/ajax/{projectId}/samples(projectId=${project.getId()})}]]*/ '/projects/ajax/1/samples',
        order: [
            [3, "desc"]
        ],
        columns: [
            {
                "data": "id",
                "orderable": false,
                "render": function (data) {
                    var state = DT.getRowState(data);
                    return '<input id="sample-' + data + '" value="' + data + '" class="sampleCB" type="checkbox"' + state + ' />';
                },
                "width": "15px"
            },
            {
                "data": "name",
                "render": function (data, type, row) {
                    'use strict';
                    var url = /*[[@{/samples/}]]*/ '/samples/',
                            template = "<a href='{{url}}{{id}}'>{{name}}</a>";
                    return Mustache.render(template, {url: url, name: data, id: row.id});
                },
                "class": "name"
            },
            {
                "data": "numFiles",
                "orderable": false,
                "class": "details-control",
                "width": "15%",
                "render": function (data) {
                    if (data > 0) {
                        return '<a class="fileViewLink" href="#">' + data + '</a>';
                    }
                    return data;
                }
            },
            {
                "data": "createdDate",
                "width": "25%"
            }
        ],
        'createdRow': function (row, data) {
            if (DT.selectedRowIds.indexOf(data.id) > -1 && DT.allRowIds[data.id].omit.length > 0) {
                $(row)
                        .find('.sampleCB')
                        .prop("indeterminate", true)
                        .prop("checked", false);
            }
        }
    }));


    $samplesTable.find('tbody').on('click', 'td.details-control a', function (e) {
        e.preventDefault();
        DT.toggleFilesView($(this).closest('tr'));
    }).on('click', '.sampleCB', function (e) {
        var $cb = $(this),
                id = $cb.val(),
                checked = $cb.prop('checked');
        DT.checkBoxClickedEvent(id, checked);
        if ($cb.closest('tr').next().attr('id') === 'files-view') {
            $('#files-view').find('.fileCB').prop('checked', checked);
        }
        setSelectAllState();
    }).on('click', '.fileCB', function () {
        var $this = $(this),
                checked = $this.prop('checked'),
                sampleId = $this.data("sample-id") + '',
                sampleCB = $("#sample-" + sampleId),
                $allCBs = $(".fileCB"),
                $checkedCBs = $(".fileCB:checked");
        DT.allRowIds[sampleId].omit = [];
        $.each($allCBs, function (i, val) {
            var $val = $(val);
            if ($val.prop('checked') === false) {
                DT.allRowIds[sampleId].omit.push($val.data("file-id") + '');
            }
        });


        sampleCB.prop('indeterminate', false).prop('checked', false);
        if ($checkedCBs.size() === 0) {
            sampleCB.prop('checked', false);
            DT.selectedRowIds.splice(DT.selectedRowIds.indexOf(sampleId));
        }
        else if ($checkedCBs.size() < $allCBs.size()) {
            sampleCB.prop('indeterminate', true);
            if (DT.selectedRowIds.indexOf(sampleId) === -1) {
                DT.selectedRowIds.push(sampleId);
            }
        }
        else {
            sampleCB.prop('checked', true);
            if (DT.selectedRowIds.indexOf(sampleId) === -1) {
                DT.selectedRowIds.push(sampleId);
            }
        }
        setSelectAllState();
    }).on('click', 'button.edit', function (e) {
        e.stopPropagation();
        DT.editRow($(this).closest('tr'));
    }).on('click', 'button.cancel', function (e) {
        e.stopPropagation();
        DT.cancelEditRow();
    }).on('click', 'button.submit', function (e) {
        e.stopPropagation();
        e.preventDefault();
        DT.sendUpdateName();
    }).on('click', 'button.filedownload', function () {
        var id = $(this).data('file-id');
        var iframe = document.getElementById('invisible');
        var src = /*[[@{/sequenceFiles/download/}]]*/ '/sequenceFiles/download/';
        iframe.src = src + id;
    });

    function setSelectAllState() {
        var state = DT.getSelectAllState();
        $btnAction.prop('disabled', true);
        $btnAction2.prop('disabled', true);
        $btnAction3.prop('disabled', true);
        if (state == "indeterminate") {
            $selectAll.prop('indeterminate', true);
            $btnAction.prop('disabled', false);
        } else {
            $selectAll.prop('indeterminate', false).prop('checked', state);
            $btnAction.prop('disabled', !state);
        }

        if (DT.selectedRowIds.length > 1) {
            $btnAction2.prop('disabled', false);
        }

        if (DT.selectedRowIds.length > 2) {
            $btnAction3.prop('disabled', false);
        }
    }

    $selectAll.on("click", function () {
        var $this = $(this),
                allSelected = $this.prop("checked");
        $samplesTable.find('input[type="checkbox"]').prop("indeterminate", false).prop('checked', allSelected);
        $btnAction.prop('disabled', !allSelected);
        $btnAction2.prop('disabled', !allSelected);
        $btnAction3.prop('disabled', !allSelected);
        DT.updateAllSelected(allSelected);
    });

    $deleteBtn.on('click', function () {
        DT.deleteSelectedSamples();
    });

    $combineBtn.on('click', function () {
        DT.combineSelectedSamples();
    });

    $copyBtn.on('click', function () {
        DT.copySelectedSamples(false);
    });

    $moveBtn.on('click', function () {
        DT.copySelectedSamples(true);
    });

    var runPipelineModal = $("#runPipelineBtn").magnificPopup({
        items: {
            src: $('#runPipelineModal'),
            type: 'inline'
        },
        closeBtnInside: true,
        callbacks: {
            beforeOpen: function () {
                var nameError = $("#name-error");
                if (!nameError.hasClass('hidden')) {
                    nameError.addClass('hidden');
                }

                var result = [];
                $.each(DT.selectedRowIds, function (i, v) {
                    result.push({id: v, omit: DT.allRowIds[v].omit});
                });
                // Ajax call to get applicable pipelines.
                $.ajax({
                    url: /*[[@{/pipelines/ajax/list.json}]]*/ '/pipelines/ajax/list.json',
                    type: 'post',
                    contentType: "application/json",
                    data: JSON.stringify(result)
                }).done(function (data) {
                    var label = /*[[' - analysis] ' + ${project.getName()}]]*/ 'project-analysis-';
                    $("#pipeline").select2({
                        data: data,
                        initSelection: function (element, callback) {
                            callback(data[0]);
                            $(element).val(data[0].id);
                        }
                    });
                });

                // Ajax call to get applicable pipelines.
                $.ajax({
                    url: /*[[@{/projects/ajax/{projectId}/referenceFiles(projectId=${project.getId()})}]]*/ '/projects/ajax/1/referenceFiles',
                    success: function (data) {
                        $("#reference").select2({
                            data: data,
                            initSelection: function (element, callback) {
                                callback(data[0]);
                                $(element).val(data[0].id);
                            }
                        });
                    }
                });


            }
        }
    });

    $('#launchBtn').on('click', function () {
        'use strict';
        var pId = $("#pipeline").val(),
                rId = $("#reference").val(),
                name = $("#name").val(),
                $nameError = $("#name-error");

        if (name.length > 0) {
            $.ajax({
                'url': /*[[@{'/pipelines/ajax/start.json'}]]*/ '/pipelines/ajax/start.json',
                'type': 'post',
                'data': 'pId=' + pId + '&rId=' + rId + '&name=' + name,
                'success': function (data) {
                    console.log(data);
                    runPipelineModal.close();
                },
                'error': function (xhr, status, error) {
                    // TODO: (14-08-28 - Josh) Need to determine what errors will occur. Reference file?
                    console.log(error);
                }
            });
        } else {
            $nameError.removeClass('hidden');
        }
    });

    DT.getAllSampleIds();
});

$('[data-tooltip!=""]').qtip({ // Grab all elements with a non-blank data-tooltip attr.
    content: {
        attr: 'data-tooltip' // Tell qTip2 to look inside this attr for its content
    },
    position: {
        target: $('input'),
        at: 'top center',
        my: 'bottom center'
    },
    style: {
        classes: 'qtip-tipsy qtip-shadow'
    }
});
/*]]>*/
</script>
</th:block>
</body>
</html>
