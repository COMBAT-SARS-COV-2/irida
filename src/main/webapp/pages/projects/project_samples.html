<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorator="projects/_base">
<head>
	<title th:text="${project.label} + ' - ' + #{project.nav.samples}"></title>
	<script>window.dependencies = ['Samples'];</script>
</head>
<body>
<main layout:fragment="main">
	<input id="projectId" type="hidden" th:value="${project.getId()}"/>

	<div class="row">
		<div class="col-md-12">
			<h1 role="heading" th:text="#{project.samples.h1(${project.label})}">__PAGE_TITLE__</h1>
		</div>
	</div>
	<div class="row">
		<div class="col-md-12" ng-controller="SamplesTableCtrl as table">
			<table id="samplesTable" class="table">
				<thead>
				<tr>
					<th></th>
					<th th:text="#{project.samples.table.name}">__NAME__</th>
					<th th:text="#{project.samples.table.organism}">__NAME__</th>
					<th th:text="#{project.samples.table.created}">__NAME__</th>
					<th th:text="#{project.samples.table.files}">__NAME__</th>
				</tr>
				</thead>
				<tbody>
				<tr class="sample-row" ng-repeat="sample in table.samples">
					<td><input type="checkbox" ng-checked="sample.selected" ng-click="table.addSample(sample)"/></td>
					<td ng-bind="sample.name"></td>
					<td ng-bind="sample.organism"></td>
					<td ng-bind="sample.createdDate | date:'medium'"></td>
					<td ng-bind="sample.files.length"></td>
				</tr>
				</tbody>
				<tfoot>
				<tr>
					<td colspan="4" class="text-center">
						<div pagination="" ng-controller="PagingCtrl as paging" ng-model="paging.page" items-per-page="paging.count"
						     total-items="paging.total" ng-change="paging.update()"></div>
					</td>
				</tr>
				</tfoot>
			</table>
		</div>
	</div>
</main>

<th:block layout:fragment="scripts" th:inline="javascript">
	<script th:inline="javascript">
		/*<![CDATA[*/
		var SamplesApp = angular.module('Samples', []);

		SamplesApp.service('SamplesService', ['$rootScope', 'Restangular', function ($rootScope, R) {
			"use strict";
			var svc = this,
					id = angular.element("#projectId").val(),
					_filter = {
						page: 0,
						sortDir: 'desc',
						sortedBy: 'createdDate',
						count: 10
					},
					base = R.all('projects/' + id + '/ajax/samples');

			svc.filter = _.clone(_filter);
			svc.samples = [];

			svc.getSamples = function (f) {
				_.extend(svc.filter, f || {});
				base.customGET("", svc.filter).then(function (data) {
					angular.copy(data.samples, svc.samples);
					$rootScope.$broadcast('PAGING_UPDATE', {total: data.totalSamples});
				});
			};

			svc.addSample = function (s) {
				return base.customPOST({sampleId: s.id}, 'cart/add/sample');
			};
		}]);

		SamplesApp.controller('PagingCtrl', ['$scope', 'SamplesService', function ($scope, SamplesService) {
			"use strict";
			var vm = this;
			vm.count = 10;
			vm.total = 0;
			vm.page = 1;

			vm.update = function () {
				SamplesService.getSamples({page: vm.page - 1, count: vm.count})
			};

			$scope.$on('PAGING_UPDATE', function (e, args) {
				vm.total = args.total;
			});
		}]);

		SamplesApp.controller('SamplesTableCtrl', ['SamplesService', function (SamplesService) {
			"use strict";
			var vm = this;

			vm.samples = SamplesService.samples;

			vm.addSample = function(s) {
				SamplesService.addSample(s);
			};

			SamplesService.getSamples({});
		}]);
		/*]]>*/
	</script>
</th:block>
</body>
</html>
