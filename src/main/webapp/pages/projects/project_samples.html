<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorator="templates/wet-boew/wet-layout">
<head>
    <title th:text="#{project.samples.title}">THIS IS SOMETHING
        WRONG</title>
</head>
<body>
<div class="container" layout:fragment="content">
    <div class="row">
        <div th:replace="templates/wet-boew/partials/sitemenu :: menu-en">MENU</div>
    </div>
    <div class="row">
        <nav th:replace="projects/project_base :: nav"></nav>
        <main class="col-md-9 col-md-push-3" role="main"
              property="mainContentOfPage">
            <div class="row">
                <div class="col-md-12">
                    <h1 role="heading"
                        th:text="#{project.samples.h1(${project.label})}">__PAGE_TITLE__</h1>
                </div>
            </div>
            <div class="row">
                <div class="col-md-12">
                    <div class="btn-toolbar" role="toolbar">
                        <div class="btn-group">
                            <button id="deleteBtn" class="btn btn-default btn-sm btn-action" disabled="true"
                                    th:text="#{project.samples.delete}">__Delete_Samples__
                            </button>
                        </div>
						<div class="btn-group">
                            <button id="copyBtn" class="btn btn-default btn-sm btn-action" disabled="true"
                                    th:text="#{project.samples.copy}">__Copy Samples__
                            </button>
                        </div>
						<div class="btn-group">
                            <button id="combineBtn" class="btn btn-default btn-sm btn-action2" disabled="true"
                                    th:text="#{project.samples.combine}">__Combine_Samples__
                            </button>
                        </div>
                    </div>
                </div>
            </div>
            <div class="row">
                <div class="col-md-12">
                    <table id="samplesTable" class="table table-striped">
                        <thead>
                        <tr role="row" th:inline="text">
                            <th data:tooltip="#{tooltip.selectall-none}"><input type="checkbox" id="selectAll"/></th>
                            <th class="sortable">[[#{project.samples.table.name}]]<i
                                    class="glyphicon"></i></th>
                            <th>[[#{project.samples.table.numFiles}]]</th>
                            <th class="sortable">[[#{project.samples.table.dateCreated}]]<i
                                    class="glyphicon"></i></th>
                            <th></th>
                        </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>
        </main>
        <div class="col-md-3 col-md-pull-9 visible-md visible-lg">
            <div class="panel panel-primary">
                <div class="panel-heading">
                    <b class="panel-title" th:text="#{project.details}">Project
                        Details</b>
                </div>
                <div class="panel-body">
                    <ul class="nav nav-pills nav-stacked details">
                        <li><span class="glyphicon glyphicon-barcode"></span><em
                                th:text="#{project.id}"></em><span class="pull-right"
                                                                   th:text="${project.getId()}"></span></li>
                        <li th:if="${project.organism} != null"><span
                                class="glyphicon glyphicon-leaf"></span><em
                                th:text="#{project.organism}"></em><span class="pull-right"
                                                                         id="project-organism"><i
                                th:text="${project.organism}"></i></span>
                        </li>
                        <li th:if="${owner} != null"><span
                                class="glyphicon glyphicon-tower"></span><em
                                th:text="#{project.owner}"></em><span class="pull-right"
                                                                      id="project-owner" th:text="${owner.label}">__DATE_CREATED__</span>
                        </li>
                        <li><span class="glyphicon glyphicon-calendar"></span><em
                                th:text="#{project.created}"></em><span class="pull-right"
                                                                        id="project-created"
                                                                        th:text="${#calendars.format(project.timestamp, 'dd MMM yyyy')}">__DATE_CREATED__</span>
                        </li>
                        <li th:if="${project.modifiedDate} != null"><span
                                class="glyphicon glyphicon-calendar"></span><em
                                th:text="#{project.modified}"></em><span class="pull-right"
                                                                         id="project-modified"
                                                                         data:livestamp="${project.modifiedDate}"
                                                                         th:title="${#calendars.format(project.modifiedDate, 'dd MMM yyyy HH:mm')}">__DATE_CREATED__</span>
                        </li>
                    </ul>
                </div>
            </div>
            <div
                    layout:replace="partials/associated-projects :: list (projects=${associatedProjects})"></div>
        </div>
    </div>
    
    
    <script type="text/html" id="copySamplesSection">
			<h2 th:text="#{project.samples.copy.title}">_Copy/Move Samples_</h2>

            <div class="form-group">
                <label class="control-label" for="copy-sample-project" th:text="#{project.samples.copy.project}">_Project_</label> 
                <input type="text" id="copy-sample-project" name="project" class="form-control input-full" />
            </div>
            <div th:if="${isOwner} or ${isAdmin}" class="form-group">
                <label class="control-label" for="copy-remove-from-project" th:text="#{project.samples.copy.remove-original}" >_Remove From This Project_</label> 
                <input type="checkbox" id="copy-remove-from-project" name="remove-from-project" />
            </div>
			<span id="copy-samples-error" class="help-block bg-danger"></span>
    </script>
	<script type="text/html" id="select2-merge">
            <h2 th:text="#{project.samples.combine-title}">__REMOVED_TITLE__</h2>
            <p th:text="#{project.samples.combine-warning}"></p>
            <div class="form-group">
                <input class="input-full" name="merge-name" type="text" id="select2-merge-input"/>
                <span id="merge-error" class="hidden help-block bg-danger"></span>
            </div>
    </script>
</div>
<div layout:fragment="scripts" th:inline="javascript">
<div th:replace="projects/project_base :: scripts"></div>
<script th:inline="javascript">
/*<![CDATA[*/
/*
Add functionality to the string object to be able to template out a string.
e.g. "fred {0}".format("flintstone") --> "fred flintstone"
*/
if (!String.prototype.format) {
    String.prototype.format = function() {
        var args = arguments;
        return this.replace(/{(\d+)}/g, function(match, number) {
            return typeof args[number] != 'undefined'
                    ? args[number]
                    : match
                    ;
        });
    };
}
function EditableDataTable() {
    this.selectedRowIds = [];
    this.allRowIds = [];
    this._isEditingRow = false;
    this._isDetailsViewOpen = false;
    this._dataTable = null;

    function createEditForm(name) {
        var form = document.createElement("form");
        form.setAttribute("role", "form");
        form.className = "form-inline";

        var group = document.createElement("div");
        group.className = "form-group";
        form.appendChild(group);

        var input = document.createElement("input");
        input.setAttribute('type', 'text');
        input.id = "editName";
        input.className = "form-control input-sm mrgn-rght-sm";
        input.setAttribute('placeholder', name);
        group.appendChild(input);

        var btn = document.createElement("button");
        btn.className = "btn btn-sm btn-primary submit";
        btn.innerHTML = /*[[#{form.btn.update}]]*/ "Update"
        group.appendChild(btn);

        return form;
    }

    function createEditBtn() {
        var btn = document.createElement("button");
        btn.className = "btn btn-default btn-xs pull-right edit";
        btn.innerHTML = /*[[#{form.btn.edit}]]*/ "Edit";
        return btn;
    }

    function createCancelBtn() {
        var btn = document.createElement("button");
        btn.className = "btn btn-info btn-sm pull-right cancel";
        btn.innerHTML = /*[[#{form.btn.cancel}]]*/ "Cancel";
        return btn;
    }

    function undoRename(sampleId, origName) {
        var that = this;
        $.ajax({
            url: /*[[@{/projects/ajax/{projectId}/samples/update(projectId=${project.getId()})}]]*/ '/projects/ajax/update',
            type: 'post',
            data: {'sampleId': sampleId, 'name': origName}
        }).done(function () {
            this.updateTable();
        });
    }

    function deleteSamples(table, noty) {
        $.ajax({
            url: /*[[@{/projects/ajax/{projectId}/samples/delete(projectId=${project.getId()})}]]*/ "/projects/ajax/{projectId}/samples/delete",
            type: "POST",
            data: "sampleIds=" + table.selectedRowIds
        }).done(function (data) {
            table.updateTable();
            table.getAllSampleIds();
            table.selectedRowIds = [];
            noty.close();
            var msg = /*[[#{project.samples.remove-success}]]*/ 'Samples successfully removed from project';
            showSuccessModal(msg);
        });
    }
    
    function copySamples(table, noty, newProject, removeFromOriginal) {
        $.ajax({
            url: /*[[@{/projects/ajax/{projectId}/samples/copy(projectId=${project.getId()})}]]*/ '/projects/ajax/1/samples/copy',
            data: "sampleIds=" + table.selectedRowIds + "&newProjectId=" + newProject +"&removeFromOriginal=" + removeFromOriginal,
            type: "post",
            success: function(data){
            	noty.close();
            	var msg = /*[[#{project.samples.copy-success}]]*/ 'Samples successfully copied';
            	var count = data.totalCopied;
                showSuccessModal(count + " " + msg);
                if(data.warnings){
                	for(warning in data.warnings){
                		showWarningModial(data.warnings[warning]);
                	}
                }
                table.selectedRowIds = [];
                table.updateTable();
                table.getAllSampleIds();
            },
            error: function(){
            	console.log(data.error);
            }
        });
    }
	function combineSamples(table, noty, nameId, newName) {
        $.ajax({
            url: /*[[@{/projects/ajax/{projectId}/samples/merge(projectId=${project.getId()})}]]*/ '/projects/ajax/1/samples/merge',
            data: "sampleIds=" + table.selectedRowIds + "&nameId=" + nameId + "&newName=" + newName,
            type: "post"
        }).done(function(data) {
            if (data.success) {
                noty.close();
                var msg = /*[[#{project.samples.combine-success}]]*/ 'Samples successfully merged samples';
                showSuccessModal(msg.format(table.selectedRowIds.length, data.success));
                table.selectedRowIds = [];
                table.updateTable();
                table.getAllSampleIds();
                $("#merge-error").addClass('hidden');
            } else {
                $("#merge-error").html(data.error.sampleName).removeClass('hidden');
            }
        });
    }

    function showSuccessModal(message) {
        noty({
            text: message,
            layout: "topCenter",
            type: "success",
            timeout: 3200
        });
    }

    function showErrorModal(message) {
        noty({
            text: message,
            layout: "topCenter",
            type: "error",
            timeout: 3200
        });
    }

	function showWarningModial(message) {
        noty({
            text: message,
            layout: "topCenter",
            type: "warning",
            timeout: 10000
        });
    }

    this._closeDetailsView = function () {
        $("tr.details")
                .removeClass('details')
                .next().remove();
        this._isDetailsViewOpen = false;
    };

    this._openDetailsView = function (el) {
        $(el).addClass('details')
                .after('<tr><td colspan="6">This is going to be the files view.</td></tr>').show();
        // TODO (2014-07-24) [Josh]: This is to be updated within the files view branch.
    };

    this._createEditRow = function (row) {
        var tdName = row.find('td.name'),
                tdBtns = row.find('td.btns'),
                name = tdName.html();
        row.addClass("editing");
        tdName.html(createEditForm(name)).find('input').focus();
        tdBtns.html(createCancelBtn());
        this._isEditingRow = true;
    };

    this._cancelEditRow = function () {
        var row = $("tr.editing"),
                tdName = row.find("td.name"),
                tdBtns = row.find("td.btns"),
                name = tdName.find("input").attr("placeholder");
        tdName.html(name);
        tdBtns.html(createEditBtn());
        row.removeClass("editing");
        this._isEditingRow = false;
    };

    this._showDeleteSampleModal = function () {
        var that = this;
        var result = true;
        noty({
            layout: "center",
            type: "warning",
            text: /*[[#{project.samples.remove-warning}]]*/ "You are about to delete samples.",
            modal: true,
            buttons: [
                {
                    addClass: 'btn btn-primary btn-sm',
                    text: /*[[#{form.btn.confim}]]*/ 'OK',
                    onClick: function ($noty) {
                        deleteSamples(that, $noty);
                    }
                },
                {
                    addClass: 'btn btn-default btn-sm',
                    text: /*#{form.btn.cancel}*/ 'Cancel',
                    onClick: function ($noty) {
                        $noty.close();
                        result = false;
                    }
                }
            ]
        });
        return result;
    };
    
    this._showCopySamplesModial = function () {
    	var that = this;
    	var div = document.getElementById('copySamplesSection');
        var template = div.innerHTML;
        $("#copy-samples-error").hide();
        noty({
            layout: "center",
            type: "default",
            text: template,
            modal: true,
            buttons: [
                {
                    addClass: 'btn btn-primary btn-sm',
                    text: /*[[#{form.btn.confim}]]*/ 'OK',
                    onClick: function ($noty) {
                        var newProject = $("#copy-sample-project").val();
                        var removeFromProject = $("#copy-remove-from-project").prop('checked');

                        if(newProject){
                        	copySamples(that, $noty, newProject,removeFromProject);
                        }
                        else{
                        	var noProject = /*[[#{project.samples.copy.no-project-selected}]]*/ 'No project selected';
                        	
                        	$("#copy-samples-error").html(noProject);
                        	$("#copy-samples-error").show();
                        }
                    }
                },
                {
                    addClass: 'btn btn-default btn-sm',
                    text: /*#{form.btn.cancel}*/ 'Cancel',
                    onClick: function ($noty) {
                        $noty.close();
                    }
                }
            ],
            callback: {
                onShow: function() {
                	//get the available projects
                	$("#copy-sample-project").select2({
                		ajax: {
                	        url: /*[[@{/projects/ajax/{id}/samples/available_projects(id=${project.getId()})}]]*/ '/projects/ajax/1/samples/available_projects',
                	        dataType: 'json',
                	        data: function (search, page) {
                	            return {
                	              term: search, // search term
                	              page: page - 1, //zero based method
                	              pageSize: 10,
                	            };
                	        },
                	        results: function (data, page) {
                	            var results = [];
                	            
                	            var more = (page * 10) < data.total;
                	            
                	            for(var id in data.results) {
                	                results.push({
                	                	"id": id,
                	                	"text": data.results[id]
                	                });
                	            }
                	            
                	            return {results:results, more:more};
                	        }
                	    },
                	    dropdownCss: {"z-index": 10000001},
                        "placeholder": /*[[#{project.samples.copy.select-project}]]*/ "Select a Project"
                    });
                }
            }
        });
    };

    this._sendAjaxNameUpdate = function (id, name, origName) {
        var that = this;
        $.ajax({
            url: /*[[@{/projects/ajax/{projectId}/samples/update(projectId=${project.getId()})}]]*/ '/projects/ajax/update',
            type: 'post',
            data: {'sampleId': id, 'name': name}
        }).done(function (data) {
            if (data.success) {
                that.updateTable();
                if (typeof origName != 'undefined') {
                    noty({
                        layout: 'topCenter',
                        type: 'success',
                        text: /*[[#{project.samples.rename-success}]]*/ 'Successfully updated sample name'
                                + '  <a href="#" id="undoRename">' +
                            /*[[#{form.btn.undo}]]*/ 'Undo'
                                + '</a>',
                        timeout: 3200,
                        callback: {
                            onShow: function () {
                                $("#undoRename").on('click', function () {
                                    undoRename(id, origName);
                                });
                            },
                            onClose: function () {
                                $("#undoRename").off('click');
                            }
                        }
                    });
                }
            }
            else {
                var input = $("tr.editing").find('input[type="text"]');
                input.focus().select();
                input.qtip({
                    content: data.error.sampleName,
                    position: {
                        at: 'top center',
                        my: 'bottom center'
                    },
                    style: {
                        classes: 'qtip-red qtip-shadow'
                    },
                    show: {
                        ready: true
                    },
                    hide: {
                        event: 'unfocus'
                    }
                });
            }
        });
    };

    this._showCombineSamplesModal = function () {
        var that = this;
        // TODO: get ajax list of samples names from server.
        $.ajax({
            url: "/projects/ajax/getNamesFromIds",
            type: "post",
            data: "sampleIds=" + this.selectedRowIds
        }).done(function (data) {
            var div = document.getElementById('select2-merge');
            var template = div.innerHTML;
            noty({
                layout: "center",
                type: "default",
                text: template,
                modal: true,
                buttons: [
                    {
                        addClass: 'btn btn-primary btn-sm',
                        text: /*[[#{form.btn.confim}]]*/ 'OK',
                        onClick: function ($noty) {
                            var mergeSampleId = $("#select2-merge-input").val();
                            var newName = "";
                            if(isNaN(mergeSampleId)){
                                newName = mergeSampleId;
                                mergeSampleId = "";
                            }

                            combineSamples(that, $noty, mergeSampleId, newName);
                        }
                    },
                    {
                        addClass: 'btn btn-default btn-sm',
                        text: /*#{form.btn.cancel}*/ 'Cancel',
                        onClick: function ($noty) {
                            $noty.close();
                        }
                    }
                ],
                callback: {
                    onShow: function() {
                        $("#select2-merge-input").select2({
                            data: data,
                            dropdownCss: {"z-index": 10000001},
                            createSearchChoice:function(term, data) {
                                if ( $(data).filter( function() {
                                            return 0 === this.text.localeCompare(term);
                                        }).length===0) {
                                    return {id:term, text:term};
                                }
                            }
                        });
                    }
                }
            });
        });
    }
}

EditableDataTable.prototype = {
    updateTable: function () {
        this._dataTable.ajax.reload();
    },
    getAllSampleIds: function () {
        var that = this;
        $.ajax({
            url: /*[[@{/projects/ajax/{projectId}/samples/getids(projectId=${project.getId()})}]]*/ "/ajax/1/samples/getids",
        }).done(function (data) {
            if (data.ids) {
                that.setAllRowIds(data.ids);
                $(".navbar li.active span.badge").html(data.ids.length);
            }
        });
    },
    setDataTable: function (table) {
        this._dataTable = table;
    },
    setAllRowIds: function (allIds) {
        this.allRowIds = allIds;
    },
    isSelectedRow: function (id) {
        return this.selectedRowIds.indexOf(id) >= 0;
    },
    updateAllSelected: function (isAllSelected) {
        if (isAllSelected) {
            this.selectedRowIds = this.allRowIds.slice(0);
        } else {
            this.selectedRowIds = [];
        }
    },
    cancelEditRow: function () {
        if (this._isEditingRow) {
            this._cancelEditRow();
        }
    },
    checkBoxClickedEvent: function (id) {
        var index = this.selectedRowIds.indexOf(id);
        if (index === -1) {
            this.selectedRowIds.push(id);
        } else {
            this.selectedRowIds.splice(index, 1);
        }
    },
    toggleFilesView: function (el) {
        if (this._isDetailsViewOpen) {
            this._closeDetailsView();
        } else {
            this._openDetailsView(el);
        }
    },
    editRow: function (row) {
        if (this._isEditingRow) {
            this._cancelEditRow();
        }
        this._createEditRow(row);
    },
    sendUpdateName: function () {
        var row = $("tr.editing"),
                id = row.find('input[type="checkbox"]').val(),
                input = row.find("#editName"),
                origName = input.attr("placeholder"),
                newName = input.val();
        if (input.data("qtip")) {
            input.qtip('destroy');
        }
        if (newName != "" && newName != origName) {
            this._sendAjaxNameUpdate(id, newName, origName);
        }
    },
    getSelectAllState: function () {
        if (this.selectedRowIds.length === 0) {
            return false; // Checkbox unchecked
        } else if (this.selectedRowIds.length === this.allRowIds.length) {
            return true; // Checkbox checked
        }
        return "indeterminate"; // Checkbox indeterminant
    },
    deleteSelectedSamples: function () {
        if (this.selectedRowIds.length > 0) {
            this._showDeleteSampleModal();
        }
    },
	combineSelectedSamples: function () {
        if (this.selectedRowIds.length > 0) {
            this._showCombineSamplesModal();
        }
    },
    copySelectedSamples: function () {
        if (this.selectedRowIds.length > 0) {
            this._showCopySamplesModial();
        }
    }
};

$(document).ready(function () {
    var $deleteBtn = $("#deleteBtn"),
            $btnAction = $(".btn-action"),
			$btnAction2 = $(".btn-action2"),
            $combineBtn = $("#combineBtn"),
            $copyBtn = $("#copyBtn"),
            $selectAll = $("#selectAll"),
            $samplesTable = $('#samplesTable'),
            DT = new EditableDataTable();

    DT.setDataTable($samplesTable.DataTable({
        dom: "<'top'ilf>rt<'bottom'p><'clear'>",
        processing: true,
        serverSide: true,
        deferRender: true,
        ajax: /*[[@{/projects/ajax/{projectId}/samples(projectId=${project.getId()})}]]*/ '/projects/ajax/1/samples',
        order: [
            [3, "desc"]
        ],
        columns: [
            {
                "data": "id",
                "orderable": false,
                "render": function (data) {
                    var checked = DT.isSelectedRow(data) ? " checked='checked'" : '';
                    return '<input type="checkbox" value="' + data + '"' + checked + ' />';
                },
                "width": "15px"
            },
            {
                "data": "name",
                "class": "name"
            },
            {
                "data": "numFiles",
                "orderable": false,
                "class": "details-control",
                "width": "15%"
            },
            {
                "data": "createdDate",
                "width": "15%"
            },
            {
                "data": "id",
                "orderable": false,
                "render": function (data) {
                    return '<button class="btn btn-default btn-xs pull-right edit">Edit</button>';
                },
                "class": "btns",
                "width": "10%"
            }
        ],
        'createdRow': function (row, data) {
            if (parseInt(data.numFiles) > 0) {
                $(row)
                        .find('.details-control')
                        .html('<a href="#">' + data.numFiles + '</a>');
            }
        },
        'fnDrawCallback': function () {
            DT.getAllSampleIds();
            var size = DT.selectedRowIds.length;
            if(size === 0) {
                $btnAction.prop('disabled', true);
                $selectAll.prop('indeterminate', false).prop('checked', false);
            }
            if(size<=2) {
                $btnAction2.prop('disabled', true);
            }

        }
    }));


    $samplesTable.find('tbody').on('click', 'td.details-control a', function (e) {
        e.preventDefault();
        DT.toggleFilesView($(this).closest('tr'));
    }).on('click', 'input[type="checkbox"]', function (e) {
        var id = $(this).val();
        DT.checkBoxClickedEvent(id);
        var state = DT.getSelectAllState();
        if (state == "indeterminate") {
            $selectAll.prop('indeterminate', true);
            $btnAction.removeAttr('disabled');
        } else {
            $selectAll.prop('indeterminate', false).prop('checked', state);
            $btnAction.prop('disabled', !state);
        }
        if(DT.selectedRowIds.length > 1) {
            $btnAction2.prop('disabled', false);
        }
        else {
            $btnAction2.prop('disabled', true);
        }
    }).on('click', 'button.edit', function (e) {
        e.stopPropagation();
        DT.editRow($(this).closest('tr'));
    }).on('click', 'button.cancel', function (e) {
        e.stopPropagation();
        DT.cancelEditRow();
    }).on('click', 'button.submit', function (e) {
        e.stopPropagation();
        e.preventDefault();
        DT.sendUpdateName();
    });

    $selectAll.on("click", function () {
        var $this = $(this);
        var allSelected = $this.prop("checked");
        $samplesTable.find('input').prop('checked', allSelected);
        $btnAction.prop('disabled', !allSelected);
        $btnAction2.prop('disabled', !allSelected);
        DT.updateAllSelected(allSelected);
    });

    $deleteBtn.on('click', function () {
        DT.deleteSelectedSamples();
    });

    $combineBtn.on('click', function () {
        DT.combineSelectedSamples();
    });
	
	$copyBtn.on('click', function(){
    	DT.copySelectedSamples();
    });
});

$('[data-tooltip!=""]').qtip({ // Grab all elements with a non-blank data-tooltip attr.
    content: {
        attr: 'data-tooltip' // Tell qTip2 to look inside this attr for its content
    },
    position: {
        target: $('input'),
        at: 'top center',
        my: 'bottom center'
    },
    style: {
        classes: 'qtip-dark qtip-shadow'
    }
});

$(".sortable").qtip({
    content: /*[[#{tooltip.table.click-sort}]]*/ "click to sort",
    position: {
        at: 'top center',
        my: 'bottom center',
        adjust: {
            y: 10
        }
    },
    style: {
        classes: 'qtip-dark qtip-shadow'
    }
});
/*]]>*/
</script>
</div>
</body>
</html>
