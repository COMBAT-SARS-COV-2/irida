<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorator="projects/_base">
<head>
	<title th:text="${project.label} + ' - ' + #{project.nav.samples}"></title>
	<script>window.dependencies = ['Samples'];</script>
</head>
<body>
<main layout:fragment="main">
	<input id="projectId" type="hidden" th:value="${project.getId()}"/>

	<div class="row">
		<div class="col-md-12">
			<h1 role="heading" th:text="#{project.samples.h1(${project.label})}">__PAGE_TITLE__</h1>
		</div>
	</div>
	<div class="row">
		<div class="col-md-12" ng-controller="SamplesTableCtrl as table">
			<table id="samplesTable" class="table">
				<thead>
				<tr>
					<th></th>
					<th th:text="#{project.samples.table.name}">__NAME__</th>
					<th th:text="#{project.samples.table.organism}">__NAME__</th>
					<th th:text="#{project.samples.table.created}">__NAME__</th>
					<th th:text="#{project.samples.table.files}">__NAME__</th>
				</tr>
				</thead>
				<tbody>
				<tr class="sample-row" ng-class="{'selected': sample.selected}" ng-repeat-start="sample in table.samples">
					<td><input class="sample-select" type="checkbox" ng-model="sample.selected"
					           ng-change="table.updateSample(sample)"/></td>
					<td ng-bind="sample.name"></td>
					<td ng-bind="sample.organism"></td>
					<td ng-bind="sample.createdDate | date:'medium'"></td>
					<td ng-if="sample.files.length==0" ng-bind="sample.files.length"></td>
					<td ng-if="sample.files.length>0">
						<button class="btn btn-default btn-xs" aria-controls="details-row"
						        ng-init="table.open[sample.id] = table.open[sample.id] === undefined ? true : table.open[sample.id]"
						        ng-click="table.open[sample.id] = !table.open[sample.id]">{{sample.files.length}}&nbsp;<span
								class="caret"></span></button>
					</td>
				</tr>
				<tr class="details-row" ng-repeat-end="" ng-if="sample.files.length>0">
					<td colspan="5">
						<div collapse="table.open[sample.id]">
							<ul class="list-group">
								<li class="list-group-item" ng-class="{'selected': f.selected}" ng-repeat="f in sample.files">
									<input type="checkbox" ng-model="f.selected"/> <a class="btn btn-default btn-xs"
									                                                  href="#"
									                                                  th:attr="ng-href=@{'/sequenceFiles/{{f.id}}'}">{{f.name}}</a>
								</li>
							</ul>
						</div>
					</td>
				</tr>
				</tbody>
				<tfoot>
				<tr>
					<td colspan="4" class="text-center">
						<div pagination="" ng-controller="PagingCtrl as paging" ng-model="paging.page" items-per-page="paging.count"
						     total-items="paging.total" ng-change="paging.update()"></div>
					</td>
				</tr>
				</tfoot>
			</table>
		</div>
	</div>
</main>

<th:block layout:fragment="scripts" th:inline="javascript">
	<script th:inline="javascript">
		/*<![CDATA[*/
		angular.module('Samples', [])
				.service('SamplesService', ['$rootScope', 'Restangular', SamplesService])
				.controller('PagingCtrl', ['$scope', 'SamplesService', PagingCtrl])
				.controller('SamplesTableCtrl', ['SamplesService', SamplesTableCtrl]);

		/*[- */
		// Responsible for all server calls for samples
		// @param $rootScope The root scope for the page.
		// @param R Restangular
		/* -]*/
		function SamplesService($rootScope, R) {
			"use strict";
			var svc = this,
					id = angular.element("#projectId").val(),
					_filter = {
						page: 0,
						sortDir: 'desc',
						sortedBy: 'createdDate',
						count: 10
					},
					base = R.all('projects/' + id + '/ajax/samples');

			svc.filter = _.clone(_filter);
			svc.samples = [];

			svc.getSamples = function (f) {
				_.extend(svc.filter, f || {});
				base.customGET("", svc.filter).then(function (data) {
					angular.copy(data.samples, svc.samples);
					$rootScope.$broadcast('PAGING_UPDATE', {total: data.totalSamples});
				});
			};

			svc.updateSample = function (s) {
				var promise = s.selected ? addSample(s) : removeSample(s);
				promise.then(function(data) {
					console.log(data);
					updateSample(data.sample);
				});
			};

			function addSample(s) {
				return base.customPOST({sampleId: s.id}, 'cart/add/sample');
			}

			function removeSample(s) {
				return base.customPOST({sampleId: s.id}, 'cart/remove/sample');
			}

			function updateSample(s) {
				var i = _.findKey(svc.samples, {id: s.id});
				svc.samples[i] = s;
			}
		}

		/*[- */
		// Handles everything to do with paging for the Samples Table
		// @param $scope Scope the controller is responsible for
		// @param SamplesService Server handler for samples.
		/* -]*/
		function PagingCtrl($scope, SamplesService) {
			"use strict";
			var vm = this;
			vm.count = 10;
			vm.total = 0;
			vm.page = 1;

			vm.update = function () {
				SamplesService.getSamples({page: vm.page - 1, count: vm.count})
			};

			$scope.$on('PAGING_UPDATE', function (e, args) {
				vm.total = args.total;
			});
		}

		/*[- */
		// Responsible for all samples within the table
		// @param SamplesService Server handler for samples.
		/* -]*/
		function SamplesTableCtrl(SamplesService) {
			"use strict";
			var vm = this;
			vm.open = [];

			vm.samples = SamplesService.samples;

			vm.updateSample = function (s) {
				SamplesService.updateSample(s);
			};

			vm.updateFile = function(s, f) {

			};

			SamplesService.getSamples({});
		}
		/*]]>*/
	</script>
</th:block>
</body>
</html>
