<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorator="templates/wet-boew/wet-layout">
<head>
    <title th:text="#{project.members.title}">THIS IS SOMETHING WRONG</title>
</head>
<body>
<div class="container" layout:fragment="content">
    <div class="row">
        <div th:replace="templates/wet-boew/partials/sitemenu :: menu-en">MENU</div>
    </div>
    <div class="row">
        <nav th:replace="projects/project_base :: nav"></nav>
        <main class="col-md-9 col-md-push-3" role="main" property="mainContentOfPage">
            <div class="row">
                <div class="col-md-12">
                    <h1 role="heading" th:text="#{project.members.members(${project.label})}">_Project Members_</h1>
                    <div class="btn-toolbar" role="toolbar">
                        <div class="btn-group">
                            <button class="btn btn-default btn-sm" th:if="${isAdmin} or ${isOwner}" id="addMembersLink" 
                                th:text="#{project.members.edit.add}">_Add Members_</button>
                        </div>
                    </div>
                </div>
            </div>
            <div class="row">
                <div class="col-md-12">
                    <table id="usersTable" class="table table-striped table-hover">
                        <thead>
                        <tr role="row" th:inline="text">
                            <th>[[#{project.table.collaborator.name}]]<i class="glyphicon"></i></th>
                            <th>[[#{project.table.collaborator.role}]]<i class="glyphicon"></i></th>
                            <th>[[#{project.table.collaborator.email}]]<i class="glyphicon"></i></th>
                            <th>[[#{project.table.collaborator.since}]]<i class="glyphicon"></i></th>
							<th th:if="${isAdmin} or ${isOwner}"></th>
                        </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>
        </main>
        <div class="col-md-3 col-md-pull-9 visible-md visible-lg">
            <div class="panel panel-primary">
                <div class="panel-heading">
                    <b class="panel-title" th:text="#{project.details}">Project Details</b>
                </div>
                <div class="panel-body">
                    <ul class="nav nav-pills nav-stacked details">
                        <li><span class="glyphicon glyphicon-barcode"></span><em th:text="#{project.id}"></em><span
                                class="pull-right" th:text="${project.getId()}"></span></li>
                        <li th:if="${project.organism} != null"><span class="glyphicon glyphicon-leaf"></span><em
                                th:text="#{project.organism}"></em><span
                                class="pull-right" id="project-organism"><i th:text="${project.organism}"></i></span>
                        </li>
                        <li th:if="${owner} != null"><span class="glyphicon glyphicon-tower"></span><em
                                th:text="#{project.owner}"></em><span
                                class="pull-right" id="project-owner"
                                th:text="${owner.label}">__DATE_CREATED__</span>
                        </li>
                        <li><span class="glyphicon glyphicon-calendar"></span><em
                                th:text="#{project.created}"></em><span
                                class="pull-right" id="project-created"
                                th:text="${#calendars.format(project.timestamp, 'dd MMM yyyy')}">__DATE_CREATED__</span>
                        </li>
                        <li th:if="${project.modifiedDate} != null"><span
                                class="glyphicon glyphicon-calendar"></span><em th:text="#{project.modified}"></em><span
                                class="pull-right" id="project-modified" data:livestamp="${project.modifiedDate}"
                                th:title="${#calendars.format(project.modifiedDate, 'dd MMM yyyy HH:mm')}">__DATE_CREATED__</span>
                        </li>
                    </ul>
                </div>
            </div>
            <div layout:replace="partials/associated-projects :: list (projects=${associatedProjects})"></div>
        </div>
    </div>
    <div class="hidden">
        <select id="template-roles" class="role-select form-control input-sm">
            <option th:each="role : ${projectRoles}" 
                th:value="${role}" 
                th:text="#{${'projectRole.'+role}}">_Role_</option>
        </select>
    </div>
</div>
<div layout:fragment="scripts" th:inline="javascript">
    <div th:replace="projects/project_base :: scripts"></div>
    <script th:inline="javascript">
        /*<![CDATA[*/
       	var DT = {
            isEditingRow: false,
            isFilesViewOpen: false,
            isAllRowsSelected: false,
            selectedRows: [],
            createEditBtn: function (userId) {
                var frag = document.createElement("div");
                var btn = document.createElement("button");
                frag.appendChild(btn);
                btn.className = "btn btn-default btn-xs edit";
                btn.innerHTML = "Edit";
                btn.setAttribute("data-userid",userId);
                btn.setAttribute("id","edit-button-"+userId);
                
                return frag.innerHTML;
            },
            createCancelBtn: function (userId) {
                var frag = document.createElement("div");
                var btn = document.createElement("button");
                frag.appendChild(btn);
                btn.className = "btn btn-info btn-xs cancel";
                btn.setAttribute("data-userid",userId);
                btn.setAttribute("id","cancel-button-"+userId);
                btn.innerHTML = "Cancel";
                return frag.innerHTML;
            },
            createEditForm: function (row) {
            	row.find(".display-role").hide();
        		row.find(".select-role").show();
            },
            cancelEditRow: function (userid) {
                if (this.isEditingRow) {
                    var row = $("tr.editing"),
                            tdBtns = row.find(".edit-button-container");
            		
                    row.find(".display-role").show();
            		row.find(".select-role").hide();
            		
                    tdBtns.html(DT.createEditBtn(userid));
                    row.removeClass("editing");
                    this.isEditingRow = false;
                }
            },
            createRemoveButton: function (row){
            	var pid = row.subject.id;
            	var uid = row.object.id;
            	var frag = document.createElement("div");
                var btn = document.createElement("button");
                frag.appendChild(btn);
                btn.className = "btn btn-danger btn-xs remove-button";
                btn.innerHTML = /*[[#{project.members.edit.remove}]]*/ 'Remove';
                btn.setAttribute("id","remove-user-"+uid);
                return frag.innerHTML;
            },
            createButtonDiv: function s(data, row){
            	//create the button toolbar
            	var toolbar = document.createElement("div");
            	toolbar.className = "btn-toolbar";
            	
            	//create the remove button group 
            	var group1 = document.createElement("div");
            	group1.className = "btn-group";
                group1.innerHTML = DT.createRemoveButton(row);

            	//create the edit button group
            	var group2 = document.createElement("div");
            	group2.className = "btn-group edit-button-container";
                group2.innerHTML = DT.createEditBtn(row.object.id);

            	//add the buttons to the toolbar
            	toolbar.appendChild(group1);
            	toolbar.appendChild(group2);
            	
            	//return the html
            	var frag = document.createElement("div");
            	frag.appendChild(toolbar);
            	return frag.innerHTML;
            }
            
        };
                   
        var showRole = true;
        
        $(document).ready(function () {
        	var table = $('#usersTable').DataTable({
                dom: "<'top'ilf>rt<'bottom'p><'clear'>",
                ajax: '/projects/ajax/[[${project.getId()}]]/members',
                deferRender: true,
                order: [
                    [0, "asc"]
                ],
                rowCallback: function(row, data){
                	var uid = data.object.id;
                	var pid = data.subject.id;
                	var userLabel = data.object.label;
                	
                	var removeUrl = [[@{/projects/{pid}(pid=${project.getId()})}]] + "/members/remove";
                	
                	var id = "#remove-user-"+uid;
                	
                	$("#usersTable").off("click",id);
                	
                	$("#usersTable").on("click",id,function(){
                		showRemoveUser(userLabel,removeUrl,uid,table);
                	});
                },
                columns: [
                    {
                        "data": "object",
                        "render": function (data) {
                            return '<a class="col-names" href="' + [[@{'/users/'}]]+data.id + '">' + data.label + '</a>';
                        }
                    },
                    {
                        "data": "projectRole",
                        "render": function (data, type, row) {
                        	var span;
                        	if (data === 'PROJECT_OWNER') {
                        		span = '<span class="glyphicon glyphicon-tower"></span>&nbsp;&nbsp;' + [[#{project.role.owner}]];
                            }
                            else {
                            	span = '<span class="glyphicon glyphicon-user"></span>&nbsp;&nbsp;' + [[#{project.role.collaborator}]];
                            }
                        	
                        	var roleSelect = $("#template-roles").clone();
                        	var userid = row.object.id;
                        	var newId = userid + "-role-select";
                        	roleSelect.attr("id",newId);
                        	roleSelect.attr("data-user",userid);
                        	roleSelect.find("option").each(function(){
                        		if($(this).val() == data){
                        			$(this).attr("selected",true);
                        		}
                        	});
                        	
                        	var select = roleSelect.wrap("<div/>").parent().html();
                        	
                        	var html = '<div class="display-role" id="display-role-'+userid+'">'+span+'</div><div class="select-role">'+select+'</div>';
                        	
                        	return html;
                        }
                    },
                    {
                        "data": "object.email",
                        "render": function (data) {
                            return '<a href="mailto:' + data + '">' + data + '</a>';
                        }
                    },
                    {
                        "data": "modifiedDate",
                        "render": function (data) {
                            return '<span data-livestamp="' + new Date(parseInt(data)) + '"></span>';
                        }
                    },
					{
                    	"data": "id",
                        "orderable": false,
                        "render": function (data, type, row) {
                        	
                        	
                            return DT.createButtonDiv(data,row);
                        },
                        "class": "btns",
                        "width": "17%"
                    }
                ],
                "drawCallback": function( settings, data ){
                	$(".select-role").hide();
                }
            });

        	
        	$("#usersTable").on('click', 'button.edit', function (e) { //click the edit button
                e.stopPropagation();
                var currEdit = $("tr.editing");
                if (currEdit.length > 0) {
                	//get the userid from the cancel button
                	var userid = currEdit.find("button.cancel").data("userid");
                    DT.cancelEditRow(userid);
                }
                var $this = $(this),
                        row = $this.closest('tr'),
                        userid = $this.data("userid"),
                        tdBtns = row.find('.edit-button-container');
                row.addClass("editing");
        		
                DT.createEditForm(row);
               	tdBtns.html(DT.createCancelBtn(userid));
                DT.isEditingRow = true;
        	}).on('click', 'button.cancel', function (e) { //click the cancel button
                e.stopPropagation();
                var $this = $(this),
                	userid = $this.data("userid");
				
                DT.cancelEditRow(userid);
            }).on("change",".role-select",function() { // Change the user role, update the role on the server
        		var newRole = $(this).val();
        		var userId = $(this).data("user");
        		var projectId = [[${project.getId()}]];
        		
        		var data = "userId="+userId+"&projectRole="+newRole;
        		var url = [[@{/projects/}]] + projectId + "/members/editrole";
        		
        		var input = $(this);
        		
        		$.ajax({
        			url:url,
        			data:data,
        			success:function(){
        				noty({
        					text: [[#{project.members.edit.role.success}]] ,
        					layout: "topCenter", 
        					type: "success",
        					timeout: 5000
        				});
        				
        				table.ajax.reload();
        			},
        			statusCode: {
        				// 403 returned if changing role would leave project without owner
        			    403: function() {
        			    	noty({
            					text: [[#{project.members.edit.role.403}]] , 
            					layout: "topCenter", 
            					type: "error",
            					timeout: 10000
            				});
        			    	
        			    }
        			},
        			error:function(){
        				noty({
        					text: [[#{project.members.edit.role.error}]] , 
        					layout: "topCenter", 
        					type: "error",
        					timeout: 10000
        				});
        				DT.cancelEditRow(userId);
        			}
        		}); 
        		
        	});
        	
        });
        
        function showRemoveUser(userLabel,removeUrl,userId,table){
        	var data = "userId="+userId;
    		noty({
    			layout: "center",
    			type: "confirmation",
    			text: [[#{project.members.edit.remove}]] + " " + userLabel + "?",
    			modal: true,
    			buttons: [
    			          {addClass: 'btn btn-primary btn-sm modial-remove-user', text: 'Ok', onClick: function($noty) {
    			              $noty.close();
    			              table.ajax.reload();
    			              $.ajax({
    			        			url:removeUrl,
    			        			data:data,
    			        			success:function(){
    			        				noty({
    			        					text: [[#{project.members.edit.remove.success}]] ,
    			        					layout: "topCenter", 
    			        					type: "success",
    			        					timeout: 5000
    			        				});
    			        				
    			        				table.ajax.reload();
    			        			},
    			        			statusCode: {
    			        				// 403 returned if changing role would leave project without owner
    			        			    403: function() {
    			        			    	noty({
    			            					text: [[#{project.members.edit.remove.403}]] , 
    			            					layout: "topCenter", 
    			            					type: "error",
    			            					timeout: 10000
    			            				});
    			        			    	
    			        			    }
    			        			},
    			        			error:function(){
    			        				noty({
    			        					text: [[#{project.members.edit.remove.error}]] , 
    			        					layout: "topCenter", 
    			        					type: "error",
    			        					timeout: 10000
    			        				})
    			        			}
    			        		});               			              
    			            }
    			          },
    			          {addClass: 'btn btn-danger btn-sm', text: 'Cancel', onClick: function($noty) {
    			              $noty.close();
    			            }
    			          }
    			        ]
    		});
    	}
        /*]]>*/
    </script>
</div>
</body>
</html>
