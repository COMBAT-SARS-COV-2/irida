<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorator="${themePath + '_page'}">
<head lang="en">
    <meta charset="UTF-8"/>
    <title th:text="${project.label}">Project</title>
</head>
<body>

<div layout:fragment="page">
    <nav class="navbar navbar-default navbar-sm" role="navigation" th:fragment="nav">
        <ul class="nav navbar-nav" th:inline="text" th:with="baseLink=${'/projects/' + project.getId()}">
            <li th:class="${activeNav} == 'dashboard' ? 'active'"><a th:href="@{${baseLink}}"><span
                    class="glyphicon glyphicon-home"></span></a></li>
            <li th:class="${activeNav} == 'metadata' ? 'active'"><a th:href="@{${baseLink} + '/metadata'}">[[#{project.nav.metadata}]]</a>
            </li>
            <li th:class="${activeNav} == 'samples' ? 'active'"><a th:href="@{${baseLink} + '/samples'}">[[#{project.nav.samples}]]<span
                    class="badge"
                    th:text="${samples}"></span>
            </a></li>
            <li th:class="${activeNav} == 'members' ? 'active'"><a th:href="@{${baseLink} + '/members'}">[[#{project.nav.members}]]<span
                    class="badge"
                    th:text="${users}"></span></a>
            </li>
            <li th:class="${activeNav} == 'analysis' ? 'active'"><a th:href="@{${baseLink} + '/analysis'}">[[#{project.nav.analysis}]]</a>
            </li>
        </ul>
    </nav>

    <main class="col-md-9 col-md-push-3" layout:fragment="main">
        <!--/*/
        This is where the main content of every project page will go.
        /*/-->
    </main>

    <aside class="col-md-3 col-md-pull-9 visible-md visible-lg" th:include="projects/partials/aside :: aside">

    </aside>
</div>

<th:block layout:fragment="baseScripts">
    <script th:src="@{/resources/bower_components/bootstrap/js/tab.js}"
            src="/resources/bower_components/bootstrap/js/tab.js"></script>
    <script th:src="@{/resources/bower_components/select2/select2.min.js}"
            src="/resources/bower_components/select2/select2.min.js"></script>
    <script th:src="@{/resources/bower_components/magnific-popup/dist/jquery.magnific-popup.min.js}"
            src="/resources/bower_components/magnific-popup/dist/jquery.magnific-popup.min.js"></script>
    <script th:src="@{/resources/bower_components/DataTables/media/js/jquery.dataTables.min.js}"
            src="/resources/bower_components/DataTables/media/js/jquery.dataTables.min.js"></script>
    <script th:src="@{/resources/bower_components/moment/min/moment-with-langs.min.js}"
            src="/resources/bower_components/moment/min/moment-with-langs.min.js"></script>
    <script th:src="@{/resources/bower_components/livestampjs/livestamp.min.js}"
            src="/resources/bower_components/livestampjs/livestamp.min.js"></script>
	<script th:src="@{/resources/js/project.js}" src="/resources/js/project.js"></script>
	<script th:src="@{/resources/bower_components/mustache/mustache.js}" src="/resources/bower_components/mustache/mustache.js"></script>

    <script th:replace="remote_apis/remote_api_connect"></script>
    <th:block layout:fragment="pageScripts">
        <script th:inline="javascript">
            $(document).ready(function () {
            	$(".api-status").each(function(){
            		var resultDiv = "#"+$(this).attr("id");
            		var apiId = $(this).data("api-id");
            		var buttonId = "#connect-button-" + apiId;
            		
            		getMiniApiStatus(apiId,resultDiv,buttonId,true);
            	});
            });
            
            function getMiniApiStatus(apiId,resultContainerId,connectButtonId){
            	var urlBase = /*[[@{/remote_api/status/}]]*/ '/remote_api/status/';
            	var invalidTokenText = /*[[#{remoteapi.status.invalid}]]*/ "Expired Token";
            	var validTokenText = /*[[#{remoteapi.status.valid}]]*/ "Valid Token";
            	var errorText = /*[[#{remoteapi.status.error}]]*/ "Connection Error";
            	
            	var qtipText;
            	var qtipClass;
            	
            	var span = document.createElement("i");
            	var resultContainer = $(resultContainerId);
            	var connectButton = $(connectButtonId);
            	var apiStatusContainer = resultContainer.closest(".api-status-container");
            	
            	$.ajax({
            		url: urlBase + apiId,
            		type: "POST",
            		success: function(data, textStatus, jqXHR){
            			if(data == "valid"){
            				span.className="glyphicon glyphicon-ok-sign";
            				qtipText = validTokenText;
            				qtipClass = "qtip-green";
            				resultContainer.html(span);
            			}
            			else if(data == "invalid_token" || data == "inactive"){
            				span.className="glyphicon glyphicon-warning-sign";
            				qtipText = invalidTokenText;
            				qtipClass = "qtip-yellow";
            				// display the connect button
            				connectButton.removeClass("hidden");
            				
            				resultContainer.html(span);
            			}
            		},
            		error: function(data, textStatus, jqXHR){
            			span.className="glyphicon glyphicon-ban-circle";
            			qtipText = errorText;
            			qtipClass = "qtip-red";
            			resultContainer.html(span);
            		},
            		complete: function(){
            			apiStatusContainer.qtip({
        		            content: {
        		                text: qtipText
        		            },
        		            position: {
        		                my: 'left center',
        		                at: 'right center',
        		                adjust: {
        		                    x: -8
        		                }
        		            },
        		            style: {
        		                classes: qtipClass
        		            }
        		        });
            		}
            	});
            }
        </script>
    </th:block>
    
</th:block>
</body>
</html>